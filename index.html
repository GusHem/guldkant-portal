<!DOCTYPE html>
<html lang="sv" class="light">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guldkant Portalen</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size: 16px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { translateY(0); } }
        @keyframes slideOutDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fade-in-fast { animation: fadeIn 0.3s ease-out forwards; }
        .animate-fade-out-fast { animation: fadeOut 0.3s ease-out forwards; }
        .animate-fade-in-scale { animation: fadeInScale 0.5s cubic-bezier(0.215, 0.610, 0.355, 1) forwards; }
        .animate-slide-in-up { animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .animate-slide-out-down { animation: slideOutDown 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
        .time-picker-column { scroll-snap-type: y mandatory; scroll-behavior: smooth; padding-top: calc(50% - 20px); padding-bottom: calc(50% - 20px); }
        .time-picker-column > div { scroll-snap-align: center; height: 40px; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">
    <div id="app-root"></div>

    <script type="module">
        const appRoot = document.getElementById('app-root');

        const state = {
            isLoggedIn: false, isLoading: true, quotes: [], selectedQuoteId: null, activeView: 'quotes',
            filter: 'prioriterade', searchTerm: '', toast: null, showWidgets: true,
            theme: 'light',
            formData: null, openSections: { info: true, menu: true, costs: true, customCosts: true, diets: true, internal: true },
            isTimePickerOpen: false, timePickerTarget: null, calendarViewDate: new Date(),
            displayLimit: 12, openCardMenu: { id: null, target: null },
            analyticsSubView: 'overview', isModalStatusOpen: false,
            isConfirmModalOpen: false, quoteToSend: null,
            isDeleteConfirmModalOpen: false, quoteToDelete: null,
            menuTemplates: {},
            isTemplateEditorOpen: false,
            wishlistItems: [],
            userVotes: {},
            isWishlistLoading: false,
            isQuoteModalFooterMinimized: false,
            isChatLogModalOpen: false,
        };

        function setState(newState, options = { render: true }) { Object.assign(state, newState); if (options.render) renderApp(); }

        const texts = { sv: { 'login.welcome': 'Välkommen till Guldkant Portalen', 'login.secret_phrase': 'Hemlig fras', 'login.button': 'Logga in', 'login.error': 'Felaktig fras.', 'nav.catering': 'Catering', 'nav.analytics': 'Analytics', 'nav.calendar': 'Kalender', 'nav.wishlist': 'Önskelista', 'dashboard.subtitle': 'En proaktiv översikt av din cateringverksamhet.', 'controls.new_quote': 'Nytt', 'status.utkast': 'Utkast', 'status.förslag-skickat': 'Förslag Skickat', 'status.godkänd': 'Godkänd', 'status.genomförd': 'Genomförd', 'status.betald': 'Betald', 'status.förlorad': 'Förlorad Affär', 'status.arkiverad': 'Arkiverad', 'filter.prioriterade': 'Prioriterade', 'filter.aktiva': 'Aktiva', 'filter.kommande': 'Kommande', 'filter.alla': 'Alla', 'modal.edit_title': 'Redigera Ärende', 'modal.create_title': 'Skapa Nytt Ärende', 'toast.saved': 'Ärende {id} har sparats.', 'toast.proposal_sent': 'Förslag för {id} har skickats.', 'toast.copied': 'Ärendet kopierades!', 'hub.title': 'NordSym Support Hub', 'hub.copied': 'Kopierad!', 'analytics.overview': 'Översikt', 'analytics.calendar': 'Kalender', 'toast.templates_saved': 'Menymallar har sparats lokalt i din webbläsare.', 'toast.deleted': 'Ärendet har raderats.', 'toast.delete_failed': 'Kunde inte radera ärendet.'} };
        const t = (key, vars = {}) => (texts.sv[key] || key).replace(/{(\w+)}/g, (_, k) => vars[k] || `{${k}}`);
        
        const defaultMenuTemplates = {
            'BUFFÉ ALTERNATIV': {
                'Italiensk buffé': "Antipasti misto/formaggi misto, Verdure marinate, Pollo de Limone, Insalata di pasta al pesto, Insalata di mozzarella, Focaccia",
                'Guldkants klassikerbuffé': "Kallskuret (rostbiff, örtbakad kycklingfilé, italiensk salami, skinka), Sallader (grönsallad, melon & myntasallad, tomat & mozzarellasallad), Såser (vitlöksdressing, örtcrème fraiche), Fransk potatissallad/Potatisgratäng, Ostbricka, Bröd och smör",
                'Streetfoodbuffé': "Caesarsallad, Crispy shrimp, Pulled pork sandwich, Sushi - California rolls, Pizzaslice, Korean BBQ chicken",
                'Mingelbuffé Trädgårdsfest': "Pulled pork sliders DIY, Pizzaslice Margherita, Västerbottenpaj, Tomat och mozzarellasallad Cocktail, Focaccia",
                'Vegetarisk buffé': "Falafel på gråärta, Trädgårdssallad, Rostad kronärtskocka och aubergine, Helbakad blomkål, Svensk tabbouleh, Semitorkade och färska tomater, Grönkålssallad, Rödbetshummus, Färskost, Surdegsbröd och knäckebröd",
                'Grillbuffé Populär': "Helgrillad fläskfilé, Majskycklingbröst smokey paprika, Helbakad blomkål, Grönkålscaesar, Rostad färskpotatis med grillade medelhavsgrönsaker, Melonsallad, Bernaisesås, Fetaoströras, Rödvinsås, Surdegsbröd med färskost",
                'Grillbuffé Grande': "BBQ flankstek, Lax med chiliglaze, Grillad citron och zucchini, Rostad delikatesspotatis, Primörsallad, Caesarsallad, Dragoncrème, Avokadoröra, Rökig tomat- och paprikaröra, Surdegsbröd med färskost",
                'Skärgårdsbuffé sommar och sol': "Matjessill, Varmrökt lax, Lyxig skärgårdspytt, Smörstekt abborre, Brödkorg"
            },
            'KOCK-RÄTTER': {
                'Lyxig skärgårdspytt med kräftor och räkor': "Purjolöksfrästa rotfrukter, bakad lax, kräftstjärtar, västerbottencrème, örter, picklad rödlök, bröd och säsongssallad",
                'Jambalaya': "Kryddigt ris, rostade grönsaker, chorizo BBQ, grillade kycklinglår, majskolv, rökt aioli, bröd och säsongssallad"
            },
            'ÖVRIGA ALTERNATIV': {
                'Snittar (blandade sorter)': "Krustad fylld med Guldkantsskagen, Blini med crème fraiche, löjrom och rödlök, Crostini med råbiff, kapris och rödbeta, Crostini med getostcrème och semitorkad tomat, Parma- och basilikarullar, Sushi nigiri med lax",
                'Bröllopsmeny': "Anpassad meny efter överenskommelse med tilltugg, förrätter, varmrätter och desserter",
                'Anpassad meny': "Diskuterat med Klara Hovmästare enligt kundens önskemål"
            }
        };

        const N8N_BASE_URL = 'https://nordsym.app.n8n.cloud/webhook/';
        const N8N_ENDPOINTS = { SAVE_QUOTE: 'guldkant-offer-intake-v2', GET_QUOTES: 'quotes', SEND_PROPOSAL: 'quote/dispatch', GET_WISHLIST: 'wishlist', VOTE_WISHLIST: 'wishlist/vote', ADD_WISHLIST_ITEM: 'wishlist/add', DELETE_QUOTE: 'quote/delete' };
        
        class DataService {
            async _post(endpoint, data) {
                try {
                    const response = await fetch(`${N8N_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const text = await response.text();
                    const jsonResponse = text ? JSON.parse(text) : {};

                    if (!response.ok) {
                        if (jsonResponse && jsonResponse.error) {
                            throw new Error(jsonResponse.error);
                        }
                        throw new Error(`N8N Error: ${response.statusText}`);
                    }
                    return jsonResponse;
                } catch (e) {
                    if (e instanceof TypeError && e.message === 'Failed to fetch') {
                         throw new Error('NetworkError');
                    }
                    throw e;
                }
            }
            async getQuotes() { const r = await fetch(`${N8N_BASE_URL}${N8N_ENDPOINTS.GET_QUOTES}`); if (!r.ok) throw new Error('Network error'); return (await r.json()).quotes.map(transformN8nQuoteToPortalQuote); }
            async saveQuote(d) { return this._post(N8N_ENDPOINTS.SAVE_QUOTE, transformPortalQuoteToN8nQuote(d)); }
            async sendProposal(payload) { return this._post(N8N_ENDPOINTS.SEND_PROPOSAL, payload); }
            async deleteQuote(recordId) { return this._post(N8N_ENDPOINTS.DELETE_QUOTE, { recordId }); }
            
            async getWishlistItems() {
                const jsonResponse = await this._post(N8N_ENDPOINTS.GET_WISHLIST, {});
                if (jsonResponse.success === false) {
                    throw new Error(jsonResponse.error || 'Kunde inte hämta önskelista.');
                }
                return jsonResponse.data || [];
            }
            async voteOnWishlistItem(itemId) {
                const response = await this._post(N8N_ENDPOINTS.VOTE_WISHLIST, { recordId: itemId });
                if (response.success === false) {
                    throw new Error(response.error || 'Röstning misslyckades.');
                }
                return response;
            }
            async addWishlistItem(itemData) {
                const response = await this._post(N8N_ENDPOINTS.ADD_WISHLIST_ITEM, itemData);
                if (response.success === false) {
                    throw new Error(response.error || 'Kunde inte lägga till förslag.');
                }
                return response.item;
            }
        }

        function safeJsonParse(jsonString, defaultValue) {
            if (jsonString === null || jsonString === undefined) return defaultValue;
            if (typeof jsonString === 'object') return jsonString;
            if (typeof jsonString !== 'string' || !jsonString.trim()) return defaultValue;
            try {
                const parsed = JSON.parse(jsonString);
                return parsed !== null ? parsed : defaultValue;
            } catch (e) {
                console.warn("JSON Parse Warning:", jsonString, e);
                return defaultValue;
            }
        }

        function normalizeStatus(statusString) {
            if (!statusString || typeof statusString !== 'string') return 'utkast';
            const normalized = statusString.toLowerCase().trim().replace(/\s+/g, '-');
            const statusMap = {
                'skickad': 'förslag-skickat',
                'förslag-skickat': 'förslag-skickat',
                'godkänd': 'godkänd',
                'accepterad': 'godkänd',
                'genomförd': 'genomförd',
                'betald': 'betald',
                'förlorad': 'förlorad',
                'nekad': 'förlorad',
                'förlorad-affär': 'förlorad',
                'arkiverad': 'arkiverad',
                'utkast': 'utkast'
            };
            return statusMap[normalized] || 'utkast';
        }

        function transformN8nQuoteToPortalQuote(n8nQuote) {
            const recordId = n8nQuote.recordId || n8nQuote.recordID || null;
            
            const standardDiets = {};
            if (n8nQuote.hasVegetarian && Number(n8nQuote.numVegetarian) > 0) standardDiets.vegetarian = Number(n8nQuote.numVegetarian);
            if (n8nQuote.hasVegan && Number(n8nQuote.numVegan) > 0) standardDiets.vegan = Number(n8nQuote.numVegan);
            if (n8nQuote.hasGlutenFree && Number(n8nQuote.numGlutenFree) > 0) standardDiets.gluten = Number(n8nQuote.numGlutenFree);
            if (n8nQuote.hasLactoseFree && Number(n8nQuote.numLactoseFree) > 0) standardDiets.laktos = Number(n8nQuote.numLactoseFree);
            if (n8nQuote.hasNutAllergy && Number(n8nQuote.numNutAllergy) > 0) standardDiets.notallergi = Number(n8nQuote.numNutAllergy);

            const quoteObject = {
                id: n8nQuote.offertId || n8nQuote.OffertID || n8nQuote.id || `GK-${Date.now()}`,
                recordId: recordId,
                status: normalizeStatus(n8nQuote.status),
                customer: n8nQuote.customerName || n8nQuote.kundNamn || '',
                customerType: n8nQuote.customerType || n8nQuote.kundtyp || 'privat',
                contactPerson: n8nQuote.contactPerson || n8nQuote.kontaktPerson || n8nQuote.ContactPerson || '',
                customerIdNumber: n8nQuote.customerIdNumber || n8nQuote.personnummer || '',
                contactEmail: n8nQuote.contactEmail || n8nQuote.email || '',
                contactPhone: n8nQuote.contactPhone || n8nQuote.telefon || '',
                address: n8nQuote.address || n8nQuote.adress || n8nQuote.Address || n8nQuote.eventPlats || '',
                guestCount: Number(n8nQuote.guestCount || n8nQuote.antalGaster) || 0,
                eventDate: (n8nQuote.eventDate || n8nQuote.eventDatum) ? new Date(n8nQuote.eventDate || n8nQuote.eventDatum).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                eventStartTime: n8nQuote.eventStartTime || n8nQuote.starttid || n8nQuote.eventTid || "17:00",
                eventEndTime: n8nQuote.eventEndTime || n8nQuote.sluttid || "01:00",
                locationTag: n8nQuote.locationTag || null, // PLATS-TAGG TILLAGD
                menuDescription: n8nQuote.menuDescription || '', // Huvudbeskrivning
                menuItems: [], // Initialiseras här, fylls på nedan
                customerRequests: n8nQuote.customerRequests || n8nQuote.kundensOnskemal || n8nQuote.KundensOnskemal || n8nQuote.otherRequests || '',
                numChefs: Number(n8nQuote.numChefs || n8nQuote.antalKockar) || 0,
                chefHours: Number(n8nQuote.chefHours) || 0,
                chefRate: Number(n8nQuote.chefRate) || 0,
                chefCost: Number(n8nQuote.chefCost || n8nQuote.kostnadKockar) || 0,
                numServingStaff: Number(n8nQuote.numServingStaff || n8nQuote.antalServering) || 0,
                servingStaffHours: Number(n8nQuote.servingStaffHours) || 0,
                servingStaffRate: Number(n8nQuote.servingStaffRate) || 0,
                servingStaffCost: Number(n8nQuote.servingStaffCost || n8nQuote.kostnadServering) || 0,
                discountAmount: Number(n8nQuote.discountAmount || n8nQuote.rabatt) || 0,
                customCosts: safeJsonParse(n8nQuote.customCosts || n8nQuote.extraKostnader || n8nQuote.customCostsJSON, []).map(c => ({ ...c, vatRate: c.vatRate || 0.25 })),
                standardDiets: standardDiets,
                customDiets: safeJsonParse(n8nQuote.customDiets || n8nQuote.ovrigSpecialkost, []),
                events: safeJsonParse(n8nQuote.events || n8nQuote.handelselogg, [{ timestamp: new Date().toISOString(), event: "Data hämtad från databas" }]),
                internalComment: n8nQuote.internalComment || n8nQuote.internaNoteringar || '',
                total: Number(n8nQuote.total || n8nQuote.totalt) || 0,
                sentDate: n8nQuote.sentDate ? new Date(n8nQuote.sentDate).toLocaleDateString('sv-SE') : null,
                aiRawLog: n8nQuote['Full Conversation Log'] || n8nQuote.aiRawLog || '',
            };
            
            // Hantera menyalternativ för bakåtkompatibilitet
            const menuItems = safeJsonParse(n8nQuote.menuItems, []);
            if (menuItems.length === 0 && (n8nQuote.meny || n8nQuote.menuPreference || Number(n8nQuote.pricePerGuest || n8nQuote.prisPerKuvert) > 0)) {
                menuItems.push({
                    description: n8nQuote.meny || n8nQuote.menuPreference || 'Standardmeny', // Ta bort n8nQuote.menuDescription
                    guestCount: Number(n8nQuote.guestCount || n8nQuote.antalGaster) || 0,
                    pricePerGuest: Number(n8nQuote.pricePerGuest || n8nQuote.prisPerKuvert) || 0
                });
            }
            quoteObject.menuItems = menuItems;
            
            if (!quoteObject.total) {
                quoteObject.total = calculateTotal(quoteObject);
            }
            return quoteObject;
        }

        function transformPortalQuoteToN8nQuote(portalQuote) {
            const payload = {
                recordId: portalQuote.recordId,
                offertId: portalQuote.id,
                status: portalQuote.status,
                customerName: portalQuote.customer,
                customerType: portalQuote.customerType,
                contactPerson: portalQuote.contactPerson,
                customerIdNumber: portalQuote.customerIdNumber,
                contactEmail: portalQuote.contactEmail,
                contactPhone: portalQuote.contactPhone,
                address: portalQuote.address,
                guestCount: Number(portalQuote.guestCount) || 0,
                eventDate: portalQuote.eventDate,
                eventStartTime: portalQuote.eventStartTime,
                eventEndTime: portalQuote.eventEndTime,
                locationTag: portalQuote.locationTag, // PLATS-TAGG TILLAGD
                menuDescription: portalQuote.menuDescription || '',
                menuItems: portalQuote.menuItems || [],
                customerRequests: portalQuote.customerRequests,
                numChefs: Number(portalQuote.numChefs) || 0,
                chefHours: Number(portalQuote.chefHours) || 0,
                chefRate: Number(portalQuote.chefRate) || 0,
                chefCost: Number(portalQuote.chefCost) || 0,
                numServingStaff: Number(portalQuote.numServingStaff) || 0,
                servingStaffHours: Number(portalQuote.servingStaffHours) || 0,
                servingStaffRate: Number(portalQuote.servingStaffRate) || 0,
                servingStaffCost: Number(portalQuote.servingStaffCost) || 0,
                discountAmount: Number(portalQuote.discountAmount) || 0,
                total: Number(portalQuote.total) || 0,
                internalComment: portalQuote.internalComment,
                customCosts: portalQuote.customCosts || [],
                standardDiets: portalQuote.standardDiets || {},
                customDiets: portalQuote.customDiets || [],
                events: portalQuote.events || [],
                // FIX: Lägg till aiRawLog i payloaden så att den inte skrivs över som tom i Airtable.
                aiRawLog: portalQuote.aiRawLog || '',
            };
            return payload;
        }

        const dataService = new DataService();
        
        const themes = { 
            light: { bg: 'bg-slate-50', cardBg: 'bg-white', text: 'text-slate-800', textSecondary: 'text-slate-500', accent: 'text-cyan-600', border: 'border-slate-200', inputBg: 'bg-slate-100', buttonPrimaryBg: 'bg-cyan-500', buttonPrimaryText: 'text-white', buttonPrimaryHover: 'hover:bg-cyan-600', buttonSecondaryBg: 'bg-slate-200', buttonSecondaryHover: 'hover:bg-slate-300', modalOverlay: 'bg-slate-900/60 backdrop-blur-sm', navActive: 'bg-cyan-500/10 text-cyan-600 border-cyan-500', navInactive: 'text-slate-600 border-transparent hover:bg-slate-200/50', filterActive: 'bg-cyan-500 text-white', focus: 'focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 ring-offset-slate-50' },
            dark: { bg: 'bg-slate-900', cardBg: 'bg-slate-800', text: 'text-slate-200', textSecondary: 'text-slate-400', accent: 'text-cyan-400', border: 'border-slate-700', inputBg: 'bg-slate-700', buttonPrimaryBg: 'bg-cyan-500', buttonPrimaryText: 'text-white', buttonPrimaryHover: 'hover:bg-cyan-600', buttonSecondaryBg: 'bg-slate-700', buttonSecondaryHover: 'hover:bg-slate-600', modalOverlay: 'bg-slate-900/80 backdrop-blur-sm', navActive: 'bg-cyan-500/10 text-cyan-400 border-cyan-500', navInactive: 'text-slate-400 border-transparent hover:bg-slate-700/50', filterActive: 'bg-cyan-500 text-white', focus: 'focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 ring-offset-slate-900' }
        };

        const formatDate = (date) => new Date(date).toLocaleDateString('sv-SE', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const calculatePriceDetails = (q) => {
            // Matpriset (pricePerGuest) är nu INKLUSIVE 12% moms. Vi räknar ut exkl. moms-värdet.
            // Loopa igenom alla menyalternativ för att få den totala matkostnaden
            let foodCostExclVat = 0;
            (q.menuItems || []).forEach(item => {
                const itemCostInclVat = (Number(item.guestCount) || 0) * (Number(item.pricePerGuest) || 0);
                foodCostExclVat += (itemCostInclVat / 1.12);
            });
            
            // Personal och extra kostnader är exklusive moms.
            const staffCost = (Number(q.chefCost) || 0) + (Number(q.servingStaffCost) || 0);
            
            let subTotalBeforeDiscount = foodCostExclVat + staffCost;
            const customCosts = (q.customCosts || []);
            customCosts.forEach(c => {
                subTotalBeforeDiscount += (Number(c.amount) || 0);
            });
        
            const discount = (Number(q.discountAmount) || 0);
            const discountFactor = subTotalBeforeDiscount > 0 ? (subTotalBeforeDiscount - discount) / subTotalBeforeDiscount : 1;
        
            const discountedFoodCost = foodCostExclVat * discountFactor;
            const discountedStaffCost = staffCost * discountFactor;
            
            const vatBreakdown = {};
        
            const foodVat = discountedFoodCost * 0.12;
            const staffVat = discountedStaffCost * 0.12;
            vatBreakdown['12'] = (vatBreakdown['12'] || 0) + foodVat + staffVat;
        
            const discountedCustomCosts = customCosts.map(c => {
                const discountedAmount = (Number(c.amount) || 0) * discountFactor;
                const vatRate = Number(c.vatRate) || 0.25;
                const itemVat = discountedAmount * vatRate;
                
                const key = (vatRate * 100).toString().replace('.0','');
                vatBreakdown[key] = (vatBreakdown[key] || 0) + itemVat;
        
                return { ...c, discountedAmount };
            });
        
            const subTotal = discountedFoodCost + discountedStaffCost + discountedCustomCosts.reduce((sum, c) => sum + c.discountedAmount, 0);
            const totalVat = Object.values(vatBreakdown).reduce((sum, v) => sum + v, 0);
            const total = subTotal + totalVat;
            
            return { subTotal, vat: totalVat, total, vatBreakdown };
        };
        const calculateTotal = (q) => calculatePriceDetails(q).total;
        
        function createElement(tag, props = {}, ...children) {
            const el = document.createElement(tag);
            Object.entries(props || {}).forEach(([key, value]) => {
                if (key.startsWith('on') && typeof value === 'function') {
                    el.addEventListener(key.substring(2).toLowerCase(), value);
                } else if (key === 'className') {
                    el.className = value;
                } else if (key === 'innerHTML') {
                    el.innerHTML = value;
                } else if (key === 'style' && typeof value === 'object') {
                    Object.assign(el.style, value);
                } else if(typeof value === 'boolean' && value) {
                    el.setAttribute(key, '');
                } else if (value !== null && value !== undefined) {
                     el.setAttribute(key, value);
                }
            });
            children.forEach(child => {
                if(child) el.append(typeof child === 'string' ? document.createTextNode(child) : child);
            });
            return el;
        }
        const icons = { nordsymLogo: `<img src="https://raw.githubusercontent.com/GusHem/Logga-utan-text/refs/heads/main/Final%20logo%20no%20text.svg" alt="NordSym Logotyp" class="w-full h-full">`, arrowDown: c => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`, chevronLeft: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>`, chevronRight: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`, plus: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>`, chartLineUp: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>`, invoice: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`, trash: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`, x: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`, briefcase: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`, calendar: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`, calendarCheck: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2zM7 15l4 4 6-6" /></svg>`, checkCircle: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`, adjustments: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>`, support: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`, tag: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2z M17 17h.01M17 13h5a2 2 0 012 2v5a2 2 0 01-2 2h-5a2 2 0 01-2-2v-5a2 2 0 012-2z"/></svg>`, moon: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`, sun: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`, filePdf: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" /></svg>`, search: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`, cog: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`, lightBulb: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a3 3 0 013-3h0a3 3 0 013 3v2m-6 0h6M12 3a5.96 5.96 0 014.243 1.757 6 6 0 010 8.486A5.96 5.96 0 0112 15a5.96 5.96 0 01-4.243-1.757 6 6 0 010-8.486A5.96 5.96 0 0112 3z" /></svg>`, chevronUp: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>`,
            chatAlt2: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V4a2 2 0 012-2h8a2 2 0 012 2v4z" /></svg>`,
            house: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7V21a1 1 0 01-1 1h-5v-4a1 1 0 00-1-1H9a1 1 0 00-1 1v4H3a1 1 0 01-1-1V10l2-2z" /></svg>`};
        
        const statusTextMap = Object.keys(texts.sv).filter(k => k.startsWith('status.')).reduce((acc, k) => ({ ...acc, [k.replace('status.', '')]: t(k) }), {});
        const statusColors = { utkast: 'bg-yellow-400', 'förslag-skickat': 'bg-blue-400', godkänd: 'bg-green-500', genomförd: 'bg-indigo-500', betald: 'bg-purple-500', förlorad: 'bg-red-500', arkiverad: 'bg-slate-400' };
        let toastTimer = null;

        function showToast(message, type = 'success') { clearTimeout(toastTimer); setState({ toast: { id: Date.now(), message, type } }); toastTimer = setTimeout(() => setState({ toast: null }), 5000); }
        async function handleSaveQuote(quote, show=true) { 
            const isNewQuote = !quote.recordId;
            
            if (isNewQuote) {
                // Lösning B: Blockera modalen medan ny post skapas
                const saveBtn = document.getElementById('modal-save-btn');
                const sendBtn = document.getElementById('modal-send-btn');
                const deleteBtn = document.getElementById('modal-delete-btn');
                
                if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Sparar...'; }
                if (sendBtn) sendBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                
                try {
                    // Vänta på svar från servern
                    const response = await dataService.saveQuote(quote); 
                    const newRecordId = response.recordId;
                    
                    if (!newRecordId) {
                        throw new Error("Servern returnerade inget recordId. Kontrollera n8n.");
                    }

                    const finalQuote = { ...quote, recordId: newRecordId };
                    
                    // Uppdatera state med den nya, kompletta posten och stäng modalen
                    const finalQuotes = [...state.quotes, finalQuote];
                    setState({ quotes: finalQuotes, formData: null, selectedQuoteId: null }); 
                    
                    if(show) showToast(t('toast.saved', {id: quote.id})); 

                } catch (e) { 
                    console.error(e); 
                    showToast(e.message || 'Sparning misslyckades.', 'error'); 
                    // Återställ knappar vid fel
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Spara'; }
                    if (sendBtn) sendBtn.disabled = false;
                    if (deleteBtn) deleteBtn.disabled = false;
                    // Stäng inte modalen, låt användaren se felet och försöka igen.
                }

            } else {
                // Befintlig logik för UPPDATERING (fungerar bra)
                const optimisticQuotes = state.quotes.map(q => q.id === quote.id ? quote : q);
                setState({ quotes: optimisticQuotes, formData: null, selectedQuoteId: null }); // Stäng modalen direkt

                try { 
                    await dataService.saveQuote(quote); // Synka i bakgrunden
                    if(show) showToast(t('toast.saved', {id: quote.id})); 
                } catch (e) { 
                    console.error(e); 
                    showToast('Sparning misslyckades.', 'error'); 
                    loadInitialData(); // Ladda om allt vid fel
                } 
            }
        }
        async function handleSendProposal(quote) {
            setState({ isConfirmModalOpen: false, quoteToSend: null });
            const updatedQuote = { ...quote, status: 'förslag-skickat' };
            
            const payload = {
                ...transformPortalQuoteToN8nQuote(updatedQuote),
                action: 'dispatch'
            };

            const optimisticQuotes = state.quotes.map(q => q.id === updatedQuote.id ? updatedQuote : q);
            setState({ quotes: optimisticQuotes, formData: null, selectedQuoteId: null });
            try { 
                await dataService.sendProposal(payload); 
                showToast(t('toast.proposal_sent', {id: quote.id})); 
            } catch (e) { 
                console.error(e); 
                if(e.message === 'NetworkError') {
                    showToast('Nätverksfel: Kunde inte skicka förslag.', 'error');
                } else {
                    showToast('Ett okänt fel uppstod.', 'error');
                }
                loadInitialData(); 
            }
        }
        async function handleDeleteQuote(quote) {
            setState({ isDeleteConfirmModalOpen: false, quoteToDelete: null });

            if (!quote || !quote.recordId) {
                console.error("Delete failed: quote is missing a recordId.", quote);
                showToast('Kan inte radera: Ärendet saknar ett databas-ID.', 'error');
                return;
            }

            const optimisticQuotes = state.quotes.filter(q => q.id !== quote.id);
            setState({ quotes: optimisticQuotes });

            try {
                await dataService.deleteQuote(quote.recordId);
                showToast(t('toast.deleted'));
            } catch (e) {
                console.error(e);
                showToast(t('toast.delete_failed'), 'error');
                loadInitialData();
            }
        }
        function handleNewQuote() { 
            const newId = `GK-${Date.now()}`; 
            const q = { 
                id: newId, recordId: null, status: 'utkast', guestCount: 20, 
                eventDate: new Date().toISOString().split('T')[0], 
                menuDescription: '',
                menuItems: [{ description: '', guestCount: 20, pricePerGuest: 375 }],
                customCosts:[], standardDiets:{}, customDiets:[],
                chefHours: 0, chefRate: 0, servingStaffHours: 0, servingStaffRate: 0,
                locationTag: null, // PLATS-TAGG TILLAGD
            }; 
            q.total = calculateTotal(q); 
            setState({ selectedQuoteId: newId, formData: q }); 
        }
        async function loadInitialData() { setState({ isLoading: true }); try { const quotes = await dataService.getQuotes(); setState({ quotes, isLoading: false }); } catch (e) { console.error(e); setState({ isLoading: false, quotes: [] }); showToast('Kunde inte ladda ärenden.', 'error'); } }
        async function loadWishlistData() {
            setState({ isWishlistLoading: true });
            try {
                const items = await dataService.getWishlistItems();
                items.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                setState({ wishlistItems: items, isWishlistLoading: false });
            } catch (e) {
                console.error(e);
                setState({ isWishlistLoading: false, wishlistItems: [] });
                const errorMessage = e.message === 'NetworkError' ? 'Nätverksfel: Kunde inte ladda önskelistan.' : e.message;
                showToast(errorMessage, 'error');
            }
        }
        
        function getFilteredAndSortedQuotes() {
            const now = new Date(); now.setHours(0, 0, 0, 0);
            return state.quotes.filter(q => {
                if (!q || !q.status) return false;
                const eventDate = new Date(q.eventDate);
                const eventIsInThePast = eventDate < now;
                const isCompletedStatus = ['genomförd', 'betald'].includes(q.status);
                const isArchivedStatus = ['förlorad', 'arkiverad'].includes(q.status);
                const isActive = !(isArchivedStatus || (eventIsInThePast && isCompletedStatus));
                
                const filterLogic = { 'prioriterade': isActive && (eventDate >= now), 'aktiva': isActive, 'kommande': eventDate >= now && !['genomförd', 'betald', 'förlorad'].includes(q.status), 'alla': true };
                const matchesFilter = filterLogic[state.filter] ?? q.status === state.filter;
                if (!matchesFilter) return false;
                const term = state.searchTerm.toLowerCase(); return !term || (q.customer || '').toLowerCase().includes(term) || (q.id || '').toLowerCase().includes(term);
            }).sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate));
        }
        
        function svgToPngDataUrl(svgText, width, height) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                img.onload = () => {
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/png'));
                };

                img.onerror = (e) => {
                    reject(new Error("Misslyckades att ladda SVG-bild för PDF-konvertering."));
                };
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgText)));
            });
        }
        
        async function generatePdf(quote) {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             const logoUrl = 'https://raw.githubusercontent.com/GusHem/Guldkant-Logga/refs/heads/main/frilagd-bild%20(1)%20(kopia%202).svg';
             const textLogoUrl = 'https://raw.githubusercontent.com/GusHem/Guldkant-Logga/refs/heads/main/frilagd-bild%20(1)%20(kopia).svg';

             try {
                const response = await fetch(logoUrl);
                if (!response.ok) throw new Error(`Nätverksfel: ${response.statusText}`);
                const svgText = await response.text();
                const logoPngDataUrl = await svgToPngDataUrl(svgText, 300, 300);
                doc.addImage(logoPngDataUrl, 'PNG', doc.internal.pageSize.getWidth() / 2 - 27.5, 15, 55, 50);

                const textResponse = await fetch(textLogoUrl);
                if (!textResponse.ok) throw new Error(`Nätverksfel: ${textResponse.statusText}`);
                const textSvgText = await textResponse.text();
                const textLogoPngDataUrl = await svgToPngDataUrl(textSvgText, 500, 100); 
                doc.addImage(textLogoPngDataUrl, 'PNG', doc.internal.pageSize.getWidth() / 2 - 35, 70, 70, 14);

             } catch(e) {
                console.error("Kunde inte rendera SVG för PDF.", e);
             }
             
             doc.setTextColor(0,0,0);
            
             doc.setFontSize(10).setFont('helvetica', 'bold');
             doc.text('Kund:', 14, 100);
             doc.text('Event:', 120, 100);
             
             doc.setFont('helvetica', 'normal');
             doc.text(quote.customer || '', 14, 106);
             doc.text(quote.contactEmail || '', 14, 111);
             doc.text(quote.contactPhone || '', 14, 116);

             doc.text(formatDate(quote.eventDate), 120, 106);
             doc.text(`${quote.guestCount} personer`, 120, 111);
             doc.text(`${quote.eventStartTime || ''} - ${quote.eventEndTime || ''}`, 120, 116);
             doc.text(`Offertnummer: ${quote.id}`, 120, 121);


             doc.setFontSize(11).setFont('helvetica', 'bold').text('MENY', 14, 140);
             doc.setFont('helvetica', 'normal');
             let menuY = 146;
             
             if (quote.menuDescription) {
                const mainDescLines = doc.splitTextToSize(quote.menuDescription, 182);
                doc.text(mainDescLines, 14, menuY);
                menuY += doc.getTextDimensions(mainDescLines).h + 4; // Add padding
             }
            
             // Add a separator if there are also items
             if (quote.menuDescription && (quote.menuItems || []).length > 0) {
                doc.setFont('helvetica', 'bold').text('Detaljerade menyval:', 14, menuY);
                menuY += 6;
             }

             (quote.menuItems || []).forEach(item => {
                if (item.description) {
                    const menuLines = doc.splitTextToSize(item.description, 182);
                    doc.text(menuLines, 14, menuY);
                    menuY += doc.getTextDimensions(menuLines).h + 2; // Add padding
                }
             });
             if ((quote.menuItems || []).length === 0 && !quote.menuDescription) {
                doc.text('Ej specificerat', 14, 146);
                menuY += 10;
             }
             const pricesYStart = menuY; // Dynamisk start-Y för pris-sektionen
             
             doc.setFontSize(11).setFont('helvetica', 'bold').text('PRISER', 14, pricesYStart + 10);

             const { subTotal, vat, total, vatBreakdown } = calculatePriceDetails(quote); 
             const formatCurrency = (amount) => (amount || 0).toLocaleString('sv-SE') + ' kr';
             
             const tableRows = [];
             // Loopa menyalternativ för pris-tabellen
             (quote.menuItems || []).forEach(item => {
                const itemCostInclVat = (Number(item.guestCount) || 0) * (Number(item.pricePerGuest) || 0);
                const itemCostExclVat = itemCostInclVat / 1.12;
                tableRows.push([
                    `Mat: ${item.description ? item.description.substring(0, 50) : 'Meny'} (12% moms)`, 
                    `${(item.pricePerGuest || 0).toLocaleString('sv-SE')} kr x ${item.guestCount}p`, 
                    formatCurrency(itemCostExclVat)
                ]);
             });

             if (quote.chefCost > 0) {
                const detailText = (quote.numChefs && quote.chefHours && quote.chefRate) 
                    ? `${quote.numChefs}st x ${quote.chefHours}h x ${quote.chefRate} kr/h`
                    : 'Fast kostnad';
                tableRows.push(['Kockar (12% moms)', detailText, formatCurrency(quote.chefCost)]); 
             }
             if (quote.servingStaffCost > 0) {
                const detailText = (quote.numServingStaff && quote.servingStaffHours && quote.servingStaffRate)
                    ? `${quote.numServingStaff}st x ${quote.servingStaffHours}h x ${quote.servingStaffRate} kr/h`
                    : 'Fast kostnad';
                tableRows.push(['Serveringspersonal (12% moms)', detailText, formatCurrency(quote.servingStaffCost)]);
             }
             (quote.customCosts || []).forEach(c => {
                const vatPercent = ((c.vatRate || 0.25) * 100);
                // --- PDF GENERERING UPPDATERING ---
                // Använd Antal och À-pris om de finns, annars visa "Extra kostnad"
                let detailText = 'Extra kostnad';
                if (c.quantity && c.unitPrice) {
                    detailText = `${c.quantity}st x ${c.unitPrice.toLocaleString('sv-SE')} kr/st`;
                }
                tableRows.push([`${c.description} (${vatPercent}% moms)`, detailText, formatCurrency(c.amount)]);
                // --- SLUT PDF UPPDATERING ---
             }); 
             if (quote.discountAmount > 0) tableRows.push(['Rabatt', '', `-${formatCurrency(quote.discountAmount)}`]);
             
             tableRows.push([{ content: 'Delsumma (ex. moms):', colSpan: 2, styles: { halign: 'right' } }, formatCurrency(subTotal)]);
             
             Object.entries(vatBreakdown).sort(([a],[b]) => b - a).forEach(([rate, amount]) => {
                if (amount > 0) {
                    tableRows.push([{ content: `Moms (${rate}%):`, colSpan: 2, styles: { halign: 'right' } }, formatCurrency(amount)]);
                }
             });

             tableRows.push([{ content: 'Totalt att betala:', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } }, { content: formatCurrency(total), styles: { fontStyle: 'bold' } }]);
             
             doc.autoTable({ 
                startY: pricesYStart + 15,
                head: [['Beskrivning', 'Detalj', 'Pris']], 
                body: tableRows, 
                theme: 'grid', 
                didDrawPage: function (data) {
                    doc.setFontSize(100).setFont('helvetica', 'normal');
                    doc.setDrawColor(221, 221, 221);
                    doc.setLineWidth(0.3);
                    doc.text('OFFERT', doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() / 2, { angle: -45, align: 'center', renderingMode: 'stroke' });
                    doc.setDrawColor(0, 0, 0); 
                    doc.setLineWidth(0.2);
                },
                headStyles: { fillColor: [184, 157, 80], textColor: [255, 255, 255], fontStyle: 'bold' }, 
                columnStyles: { 0: {cellWidth: 100}, 1: {halign: 'right'}, 2: { halign: 'right' } } 
            });

             const pageHeight = doc.internal.pageSize.getHeight();
             doc.setFontSize(8).setFont('helvetica', 'normal');
             const footerText1 = "Offerten är giltig i 30 dagar. När vi är överens om innehåll skickar Guldkant en beställningsbekräftelse via mail som behöver ett godkännande från er sida.";
             const footerText2 = "Menyförslag av. Guldkant, erik@restaurangguldkant.se / 076-033 47 38";
             const footerText3 = "Restaurang Guldkant | org nr 556719-3635 | Grönsakstorget 6, 593 33 Västervik";
             doc.text(footerText1, doc.internal.pageSize.getWidth() / 2, pageHeight - 25, { align: 'center' });
             doc.text(footerText2, doc.internal.pageSize.getWidth() / 2, pageHeight - 20, { align: 'center' });
             doc.text(footerText3, doc.internal.pageSize.getWidth() / 2, pageHeight - 15, { align: 'center' });

             doc.save(`Guldkant-Offert-${quote.id}-${quote.eventDate}.pdf`);
        }
        
        function renderLogin() {
            let error = null; 
            const form = createElement('form', { className: 'w-full max-w-sm p-8 space-y-6 bg-white rounded-2xl shadow-2xl animate-fade-in-scale', onsubmit: e => { e.preventDefault(); if (e.target.elements.secretPhrase.value === 'guldbyxor') { setState({isLoggedIn: true}); loadInitialData(); } else { error = t('login.error'); renderApp(); } } });
            form.append(
                createElement('img', { src: 'https://raw.githubusercontent.com/GusHem/Guldkant-Logga/refs/heads/main/frilagd-bild%20(1)%20(kopia%202).svg', alt: 'Guldkant Logotyp', className: 'w-32 h-32 mx-auto' }),
                createElement('h1', { className: 'text-2xl font-bold text-center' }, t('login.welcome'))
            );
            if(error) form.append(createElement('p', {className: 'text-red-500 text-center'}, error));
            form.append(createElement('input', { className: 'w-full p-4 bg-slate-100 rounded-xl', type: 'password', name: 'secretPhrase', placeholder: t('login.secret_phrase') }), createElement('button', { className: 'w-full py-4 font-bold bg-cyan-500 text-white rounded-xl hover:bg-cyan-600' }, t('login.button')));
            return createElement('div', { className: 'min-h-screen w-full bg-slate-50 flex items-center justify-center p-4' }, form);
        }
        function renderToast() { if (!state.toast) return null; const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' }; return createElement('div', { className: `fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 text-white font-medium rounded-full shadow-2xl z-50 animate-fade-in-fast ${colors[state.toast.type]}` }, state.toast.message); }
        
        function renderConfirmModal() {
            if(!state.isConfirmModalOpen) return null;
            const theme = themes[state.theme];
            return createElement('div', { className: `fixed inset-0 z-50 ${theme.modalOverlay} flex items-center justify-center p-4 animate-fade-in-fast` },
                createElement('div', { className: `${theme.cardBg} rounded-2xl p-6 shadow-2xl max-w-sm w-full text-center animate-fade-in-scale`},
                    createElement('h2', { className: 'text-lg font-bold mb-2' }, 'Skicka förslag till kund?'),
                    createElement('p', { className: `${theme.textSecondary} mb-6`}, 'Ett e-postmeddelande med förslaget kommer att skickas till kunden. Är du säker på att du vill fortsätta?'),
                    createElement('div', { className: 'flex justify-center gap-4' },
                        createElement('button', { className: `px-6 py-2 font-semibold rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, onclick: () => setState({ isConfirmModalOpen: false, quoteToSend: null })}, 'Avbryt'),
                        createElement('button', { className: `px-6 py-2 font-semibold rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover}`, onclick: () => handleSendProposal(state.quoteToSend) }, 'Ja, skicka')
                    )
                )
            );
        }

        function renderDeleteConfirmModal() {
            if(!state.isDeleteConfirmModalOpen) return null;
            const theme = themes[state.theme];
            return createElement('div', { className: `fixed inset-0 z-50 ${theme.modalOverlay} flex items-center justify-center p-4 animate-fade-in-fast` },
                createElement('div', { className: `${theme.cardBg} rounded-2xl p-6 shadow-2xl max-w-sm w-full text-center animate-fade-in-scale`},
                    createElement('h2', { className: 'text-lg font-bold mb-2' }, 'Radera ärende permanent?'),
                    createElement('p', { className: `${theme.textSecondary} mb-6`}, 'Denna åtgärd kan inte ångras.'),
                    createElement('div', { className: 'flex justify-center gap-4' },
                        createElement('button', { className: `px-6 py-2 font-semibold rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, onclick: () => setState({ isDeleteConfirmModalOpen: false, quoteToDelete: null })}, 'Avbryt'),
                        createElement('button', { className: `px-6 py-2 font-semibold rounded-lg bg-red-500 text-white hover:bg-red-600`, onclick: () => handleDeleteQuote(state.quoteToDelete) }, 'Ja, radera')
                    )
                )
            );
        }

        function renderAppShell() {
            const theme = themes[state.theme];
            const mainContent = createElement('main', { className: 'ml-16 md:ml-56 p-4 md:p-8' });
            const nav = createElement('nav', { className: `fixed top-0 left-0 h-full w-16 md:w-56 ${theme.cardBg} border-r ${theme.border} flex flex-col z-30 transition-colors` });
            
            const navLinks = [
                { id: 'catering', icon: icons.invoice, text: t('nav.catering'), active: state.activeView === 'quotes', action: () => setState({ activeView: 'quotes' }) },
                { id: 'analytics', icon: icons.chartLineUp, text: t('nav.analytics'), active: state.activeView === 'analytics' && state.analyticsSubView === 'overview', action: () => setState({ activeView: 'analytics', analyticsSubView: 'overview' }) },
                { id: 'calendar', icon: icons.calendar, text: t('nav.calendar'), active: state.activeView === 'analytics' && state.analyticsSubView === 'calendar', action: () => setState({ activeView: 'analytics', analyticsSubView: 'calendar' }) },
                { id: 'wishlist', icon: icons.lightBulb, text: t('nav.wishlist'), active: state.activeView === 'wishlist', action: () => { setState({ activeView: 'wishlist' }); loadWishlistData(); } },
            ];

            nav.append(
                createElement('div', { className: `h-20 flex items-center justify-center md:justify-start md:pl-6 border-b ${theme.border} flex-shrink-0` },
                    createElement('img', { src: "https://raw.githubusercontent.com/GusHem/Guldkant-Logga/refs/heads/main/frilagd-bild%20(1)%20(kopia%202).svg", alt: "Guldkant Logotyp", className: "w-10 h-10 md:hidden" }),
                    createElement('img', { src: "https://raw.githubusercontent.com/GusHem/Guldkant-Logga/refs/heads/main/frilagd-bild%20(1)%20(kopia).svg", alt: "Guldkant", className: "hidden md:block h-6" })
                ),
                createElement('div', { className: 'flex-grow py-4' }, ...navLinks.map(link => 
                    createElement('a', { href: '#', className: `flex items-center h-12 px-5 md:pl-6 my-1 border-l-4 ${link.active ? theme.navActive : theme.navInactive}`, onclick: e => { e.preventDefault(); link.action(); } }, 
                        createElement('div', { className:'w-6 h-6', innerHTML: link.icon('') }), 
                        createElement('span', { className:'hidden md:inline ml-4 font-semibold'}, link.text)
                    )
                )),
                createElement('a', { href: 'https://nordsym.com', target:'_blank', className: `flex-shrink-0 border-t ${theme.border} p-4 flex items-center justify-center md:justify-start group` }, createElement('div', {className:`w-8 h-8 ${theme.textSecondary} group-hover:${theme.accent}`, innerHTML: icons.nordsymLogo}), createElement('span', {className:`hidden md:inline ml-3 text-sm font-semibold ${theme.textSecondary} group-hover:${theme.text}`},'NordSym'))
            );
            
            return { mainWrapper: createElement('div', {className:`min-h-screen ${theme.bg} transition-colors`}, nav, mainContent), mainContent };
        }
        
        function renderQuoteList() {
            const quotes = getFilteredAndSortedQuotes();
            const contentList = document.getElementById('quote-list-container');
            if (!contentList) return;

            while (contentList.firstChild) {
                contentList.removeChild(contentList.firstChild);
            }

            quotes.slice(0, state.displayLimit).forEach(quote => contentList.append(renderQuoteCard(quote)));
            
            const loadMoreButton = document.getElementById('load-more-btn');
            if (loadMoreButton) {
                if (quotes.length > state.displayLimit) {
                    loadMoreButton.style.display = 'block';
                } else {
                    loadMoreButton.style.display = 'none';
                }
            }
        }

        function renderDashboard() {
            const theme = themes[state.theme];
            
            const themeToggleButton = createElement('button', { 
                className: `p-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, 
                onclick: () => {
                    const newTheme = state.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('guldkant-theme', newTheme);
                    setState({ theme: newTheme });
                    document.documentElement.classList.toggle('dark', newTheme === 'dark');
                }
            }, 
            createElement('div', { innerHTML: state.theme === 'light' ? icons.moon('w-6 h-6') : icons.sun('w-6 h-6')})
            );

            const header = createElement('header', { className: 'flex items-center justify-between' });
            header.append(createElement('div', {}, createElement('p', { className: `mt-1 text-lg ${theme.textSecondary}` }, t('dashboard.subtitle'))), 
            createElement('div', {className: 'flex items-center gap-2'}, themeToggleButton, createElement('button', { className: `p-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, onclick: () => setState({ showWidgets: !state.showWidgets }), innerHTML: icons.adjustments('w-6 h-6') })));
            
            const widgetsContainer = createElement('div', { className: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 transition-all duration-500 ease-in-out overflow-hidden ${state.showWidgets ? 'max-h-[900px] md:max-h-[500px] opacity-100 mt-6' : 'max-h-0 opacity-0 mt-0'}` });
            if(state.showWidgets) {
                const widgetIcons = { 'Aktiva Ärenden': icons.briefcase, 'Nya Förfrågningar': icons.tag, 'Kommande Events (7d)': icons.calendarCheck, 'Godkända Offerer': icons.checkCircle };
                const getWidgetData = (filter, label, filterKey) => ({ quotes: state.quotes.filter(filter).slice(0, 3), count: state.quotes.filter(filter).length, label, filterKey});
                
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const isActiveFilter = q => {
                    const eventDate = new Date(q.eventDate);
                    const eventIsInThePast = eventDate < now;
                    const isCompletedStatus = ['genomförd', 'betald'].includes(q.status);
                    const isArchivedStatus = ['förlorad', 'arkiverad'].includes(q.status);
                    return !(isArchivedStatus || (eventIsInThePast && isCompletedStatus));
                };

                const widgetDefs = [ 
                    getWidgetData(isActiveFilter, 'Aktiva Ärenden', 'aktiva'), 
                    getWidgetData(q => q.status === 'utkast', 'Nya Förfrågningar', 'utkast'), 
                    getWidgetData(q => { const d = new Date(q.eventDate); const today = new Date(); const in7 = new Date(new Date().setDate(today.getDate() + 7)); return d >= today && d <= in7; }, 'Kommande Events (7d)', 'kommande'),
                    getWidgetData(q => q.status === 'godkänd' || q.status === 'betald', 'Godkända Offerer', 'godkänd')
                ];
                widgetDefs.forEach(def => {
                    const widget = createElement('div', { className: `${theme.cardBg} border ${theme.border} rounded-2xl p-5` }, 
                        createElement('div', {className: 'flex items-start justify-between mb-2 cursor-pointer', onclick: () => setState({filter: def.filterKey})}, 
                            createElement('div', {}, createElement('p', { className: 'text-2xl font-bold' }, def.count.toString()), createElement('p', { className: `text-sm ${theme.textSecondary}` }, def.label)),
                            createElement('div', { className: 'w-8 h-8 p-1.5 bg-cyan-100 text-cyan-600 rounded-lg dark:bg-cyan-500/20 dark:text-cyan-400', innerHTML: widgetIcons[def.label]('w-full h-full')})
                        ),
                         createElement('div', {className:'space-y-1 mt-2'}, ...def.quotes.map(q => 
                            createElement('div', {className: `flex items-center gap-2 p-1 rounded ${theme.bg}`}, 
                                createElement('div', {className:`w-2 h-2 rounded-full ${statusColors[q.status]}`}),
                                createElement('span', {className: 'text-xs truncate'}, q.customer)
                            )
                        ))
                    );
                    widgetsContainer.append(widget);
                });
            }

            const controlsWrapper = createElement('div', { className: `sticky top-0 z-20 py-4 ${theme.bg} transition-colors` });
            const statusDropdownContainer = createElement('div', { className: 'relative flex-shrink-0' });
            
            const statusButton = createElement('button', { className: `flex items-center gap-2 px-4 py-3 font-semibold ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} rounded-lg whitespace-nowrap`, 
                onclick: (e) => {
                    e.stopPropagation();
                    const menu = document.getElementById('global-filter-status-menu');
                    if (menu) {
                        menu.remove();
                    } else {
                         const targetRect = e.currentTarget.getBoundingClientRect();
                         const statuses = ['alla', 'prioriterade', 'aktiva', 'kommande', ...Object.keys(statusTextMap)];
                         const newMenu = createElement('div', { id: 'global-filter-status-menu', className: `fixed w-48 ${theme.cardBg} rounded-lg shadow-lg border ${theme.border} z-30 animate-fade-in-fast`, style: { top: `${targetRect.bottom + 5}px`, left: `${targetRect.left}px`} });
                         [...new Set(statuses)].forEach(status => {
                             let label = t(`filter.${status}`);
                             if (label === `filter.${status}`) {
                                label = statusTextMap[status] || status;
                             }
                             newMenu.append(createElement('a', { className: 'block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer', onclick: () => {
                                 setState({ filter: status, displayLimit: 12 });
                                 newMenu.remove();
                            } }, label));
                         });
                         document.body.append(newMenu);
                    }
                } 
            }, (() => {
                let label = t(`filter.${state.filter}`);
                if (label === `filter.${state.filter}`) {
                    label = statusTextMap[state.filter] || state.filter;
                }
                return label;
            })(), createElement('div', {innerHTML: icons.arrowDown('w-4 h-4')}));

            statusDropdownContainer.append(statusButton);

            const searchWrapper = createElement('div', { className: 'relative flex-grow' });
            searchWrapper.append(
                createElement('div', { 
                    className: `absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none`, 
                    innerHTML: icons.search(`w-5 h-5 ${theme.textSecondary}`) 
                }),
                createElement('input', { 
                    className: `w-full pl-10 pr-4 py-3 ${theme.inputBg} rounded-lg`, 
                    value: state.searchTerm, 
                    oninput: e => {
                        setState({ searchTerm: e.target.value }, { render: false });
                        renderQuoteList();
                    } 
                })
            );

            const newQuoteButton = createElement('button', { className: `flex items-center gap-2 px-4 py-3 font-semibold ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} rounded-lg ${theme.buttonPrimaryHover} whitespace-nowrap`, onclick: handleNewQuote, innerHTML: icons.plus('w-5 h-5') + `<span class="hidden sm:inline">${t('controls.new_quote')}</span>` });
            
            const controlsFlexContainer = createElement('div', { className: 'flex items-center gap-2 md:gap-4' });
            controlsFlexContainer.append(
                statusDropdownContainer,
                searchWrapper,
                newQuoteButton
            );
            controlsWrapper.append(controlsFlexContainer);
            
            const contentList = createElement('div', { id: 'quote-list-container', className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6' });
            const loadMoreButton = createElement('button', { id: 'load-more-btn', className:`md:col-span-full w-full py-3 font-semibold ${theme.buttonSecondaryBg} rounded-lg`, style: {display: 'none'}, onclick:()=>{setState({displayLimit: state.displayLimit+12}, {render:false}); renderQuoteList();} }, 'Ladda fler');
            
            const dashboardContainer = createElement('div', {className: 'space-y-6'}, header, widgetsContainer, controlsWrapper, contentList, loadMoreButton);
            setTimeout(renderQuoteList, 0);
            return dashboardContainer;
        }

        function renderQuoteCard(quote) {
            const theme = themes[state.theme];
            const card = createElement('div', { className: `${theme.cardBg} border ${theme.border} rounded-2xl p-5 flex flex-col gap-4 transition-shadow hover:shadow-xl dark:hover:shadow-cyan-500/10 animate-fade-in-fast relative` });
            const statusButton = createElement('button', {className:'flex items-center gap-2', 
                onclick: (e) => { 
                    e.stopPropagation();
                    const existingMenu = document.getElementById('global-card-status-menu');
                    if (existingMenu) {
                        existingMenu.remove();
                    }
                    if (state.openCardMenu.id !== quote.id) {
                        const targetRect = e.currentTarget.getBoundingClientRect();
                        const menu = createElement('div', { 
                            id: 'global-card-status-menu',
                            className: `fixed w-40 ${theme.cardBg} rounded-lg shadow-lg border ${theme.border} z-50 animate-fade-in-fast`,
                            style: { top: `${targetRect.bottom + 5}px`, left: `${targetRect.left}px`}
                        });
                        Object.keys(statusTextMap).forEach(s => {
                            menu.append(createElement('a', { className: `block px-3 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer`, href: '#', onclick: e => { 
                                e.preventDefault(); 
                                e.stopPropagation(); 
                                handleSaveQuote({...quote, status: s});
                                menu.remove();
                                setState({openCardMenu: {id: null, target: null}}, {render: false});
                            } }, statusTextMap[s]));
                        });
                        document.body.append(menu);
                        setState({openCardMenu: {id: quote.id, target: e.currentTarget}}, {render: false});
                    } else {
                        setState({openCardMenu: {id: null, target: null}}, {render: false});
                    }
                } 
            }, createElement('div', {className:`w-3 h-3 ${statusColors[quote.status]} rounded-full`}), createElement('span',{className:`text-sm font-semibold ${theme.textSecondary}`}, statusTextMap[quote.status]), createElement('div', {innerHTML: icons.arrowDown('w-4 h-4 text-slate-400')}));
            
            // --- NY KNAPP FÖR PLATS-TAGG (Steg 4) ---
            const locationColorMap = {
                'vimmerby': 'text-blue-500',
                'vastervik': 'text-purple-500',
                'default': 'text-slate-400'
            };
            const locationColor = locationColorMap[quote.locationTag] || locationColorMap['default'];

            const locationTagButton = createElement('button', {
                className: `p-1 rounded-full ${locationColor} hover:bg-slate-200 dark:hover:bg-slate-700`,
                onclick: (e) => {
                    e.stopPropagation();
                    // --- NY LOGIK FÖR DROPDOWN (Steg 6) ---
                    const theme = themes[state.theme];
                    
                    // Stäng andra menyer
                    const existingMenu = document.getElementById('global-card-status-menu');
                    if (existingMenu) {
                        existingMenu.remove();
                    }
                    if (state.openCardMenu.id) {
                        setState({openCardMenu: {id: null, target: null}}, {render: false});
                    }

                    // Hämta position
                    const targetRect = e.currentTarget.getBoundingClientRect();
                    
                    // Skapa menyn
                    const menu = createElement('div', { 
                        id: 'global-card-status-menu', // Återanvänder ID för auto-stängning
                        className: `fixed w-40 ${theme.cardBg} rounded-lg shadow-lg border ${theme.border} z-50 animate-fade-in-fast`,
                        style: { top: `${targetRect.bottom + 5}px`, left: `${targetRect.right - 160}px`} // Positionera från höger
                    });

                    // Definiera val
                    const options = [
                        { label: 'Vimmerby', value: 'vimmerby' },
                        { label: 'Västervik', value: 'vastervik' },
                        { label: 'Ej vald', value: null }
                    ];

                    // Loopa och skapa meny-items
                    options.forEach(opt => {
                        menu.append(createElement('a', { 
                            className: `block px-3 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer`, 
                            href: '#', 
                            onclick: (ev) => { 
                                ev.preventDefault(); 
                                ev.stopPropagation();
                                // Spara utan att visa toast
                                handleSaveQuote({...quote, locationTag: opt.value}, false); 
                                menu.remove();
                            } 
                        }, opt.label));
                    });
                    
                    // Lägg till i DOM
                    document.body.append(menu);
                    // --- SLUT NY LOGIK ---
                }
            }, createElement('div', {innerHTML: icons.house('w-5 h-5')}));
            // --- SLUT NY KNAPP ---
            
            const cardContent = createElement('div', { className: 'cursor-pointer', onclick: () => setState({ selectedQuoteId: quote.id, formData: JSON.parse(JSON.stringify(quote)) }) });
            cardContent.append(createElement('h3', {className:'text-lg font-bold truncate mt-2'}, quote.customer || 'Namnlös Offert'));
            cardContent.append(createElement('div', {className:'grid grid-cols-2 gap-4 pt-2 mt-auto'}, createElement('div', {}, createElement('p',{className:`text-xs ${theme.textSecondary}`},'Eventdatum'), createElement('p',{className:'font-semibold'}, formatDate(quote.eventDate))), createElement('div',{className:'text-right'}, createElement('p',{className:`text-xs ${theme.textSecondary}`},'Totalt'), createElement('p',{className:'font-semibold'}, `${Math.round(quote.total).toLocaleString('sv-SE')} kr`))));
            
            const cardHeader = createElement('div', {className:'flex justify-between items-start'}, 
                statusButton,
                createElement('div', { className: 'flex items-center gap-1' }, // Behållare för ikoner
                    locationTagButton, // Ny knapp tillagd här
                    createElement('button', { 
                        className: `p-1 rounded-full text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700`,
                        onclick: (e) => {
                            e.stopPropagation();
                            setState({ isDeleteConfirmModalOpen: true, quoteToDelete: quote });
                        }
                    }, createElement('div', {innerHTML: icons.trash('w-5 h-5')}))
                ) // Avslutar 'flex items-center gap-1'
            ); // Avslutar 'cardHeader'
            card.append(cardHeader, cardContent);
 
             return card;
         }
        
        function renderAnalyticsPage() {
            const theme = themes[state.theme];
            const header = createElement('div', {}, 
                createElement('h1', { className: 'text-3xl md:text-4xl font-extrabold' }, t('nav.analytics')),
                createElement('p', { className: `mt-1 text-lg ${theme.textSecondary}` }, 'Få insikter om din verksamhet.')
            );

            const tabContainer = createElement('div', { className: `flex items-center gap-4 border-b ${theme.border} mt-6`});
            ['overview', 'calendar'].forEach(view => {
                const isActive = state.analyticsSubView === view;
                tabContainer.append(createElement('button', {
                    className: `py-3 px-4 font-semibold ${isActive ? `border-b-2 ${theme.border.replace('slate-200', 'cyan-500').replace('slate-700', 'cyan-500')} ${theme.accent}` : `${theme.textSecondary} hover:${theme.text}`}`,
                    onclick: () => setState({ analyticsSubView: view })
                }, t(`analytics.${view}`)));
            });

            const contentContainer = createElement('div', { className: 'mt-6' });
            if (state.analyticsSubView === 'calendar') {
                contentContainer.append(renderCalendarView());
            } else {
                contentContainer.append(createElement('div', { className: `flex items-center justify-center h-64 ${theme.cardBg} border ${theme.border} rounded-2xl` }, createElement('p', {className: theme.textSecondary}, 'Översikt under utveckling.')));
            }
            
            return createElement('div', {}, header, tabContainer, contentContainer);
        }

        function renderCalendarView() {
            const theme = themes[state.theme];
            const today = new Date();
            const currentDate = state.calendarViewDate;
            const monthNames = ["Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti", "September", "Oktober", "November", "December"];
            const header = createElement('div', { className: 'flex items-center justify-between mb-4'},
                createElement('h2', { className: 'text-xl font-bold'}, `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`),
                createElement('div', { className: 'flex items-center gap-2'},
                    createElement('button', { className: `p-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, innerHTML: icons.chevronLeft('w-5 h-5'), onclick: () => setState({ calendarViewDate: new Date(currentDate.setMonth(currentDate.getMonth() - 1)) }) }),
                    createElement('button', { className: `p-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, innerHTML: icons.chevronRight('w-5 h-5'), onclick: () => setState({ calendarViewDate: new Date(currentDate.setMonth(currentDate.getMonth() + 1)) }) })
                )
            );

            const calendarGrid = createElement('div', { className: `grid grid-cols-7 gap-px ${theme.border.replace('border-', 'bg-')} border ${theme.border} rounded-lg overflow-hidden` });
            const days = ['Mån', 'Tis', 'Ons', 'Tor', 'Fre', 'Lör', 'Sön'];
            days.forEach(day => calendarGrid.append(createElement('div', { className: `text-center font-semibold text-sm py-2 ${theme.cardBg} ${theme.textSecondary}` }, day)));

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7;

            for (let i = 0; i < startDay; i++) {
                calendarGrid.append(createElement('div', { className: `${theme.bg} min-h-[120px]` }));
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === today.toDateString();
                const dayCell = createElement('div', { className: `${theme.cardBg} p-2 min-h-[120px] flex flex-col` });
                dayCell.append(createElement('div', { className: `w-7 h-7 flex items-center justify-center rounded-full text-sm font-semibold ${isToday ? 'bg-cyan-500 text-white' : ''}` }, day.toString()));
                
                const eventsThisDay = state.quotes.filter(q => new Date(q.eventDate).toDateString() === date.toDateString());
                eventsThisDay.forEach(q => {
                    dayCell.append(createElement('div', { className: `text-xs bg-opacity-20 ${statusColors[q.status]} text-slate-800 dark:text-slate-200 rounded px-1 py-0.5 mt-1 truncate cursor-pointer`, title: q.customer, onclick: () => setState({selectedQuoteId: q.id, formData: JSON.parse(JSON.stringify(q))}) }, q.customer));
                });

                calendarGrid.append(dayCell);
            }

            return createElement('div', { className: `${theme.cardBg} p-4 rounded-2xl border ${theme.border}` }, header, calendarGrid);
        }

        function renderWishlistPage() {
            const theme = themes[state.theme];

            const header = createElement('div', {}, 
                createElement('h1', { className: 'text-3xl md:text-4xl font-extrabold' }, t('nav.wishlist')),
                createElement('p', { className: `mt-1 text-lg ${theme.textSecondary}` }, 'Här kan du se kommande funktioner, rösta på idéer och lämna egna förslag.')
            );

            const featureListContainer = createElement('div', { className: 'mt-8 space-y-4' });

            if (state.isWishlistLoading) {
                featureListContainer.append(createElement('div', { className: 'text-center p-8' }, 'Laddar önskelista...'));
            } else if (state.wishlistItems.length === 0) {
                 featureListContainer.append(createElement('div', { className: `text-center p-8 ${theme.cardBg} border ${theme.border} rounded-2xl` }, 'Inga förslag har lagts till än. Bli den första!'));
            } else {
                const features = state.wishlistItems;
                
                const statusInfo = {
                    planerad: { text: 'Planerad', color: 'bg-blue-500' },
                    'under utveckling': { text: 'Under Utveckling', color: 'bg-yellow-500' },
                    idé: { text: 'Idé', color: 'bg-slate-400' },
                    släppt: { text: 'Släppt', color: 'bg-green-500' },
                    'Idea': { text: 'Idé', color: 'bg-slate-400' },
                    'Planned': { text: 'Planerad', color: 'bg-blue-500' },
                    'In progress': { text: 'Under Utveckling', color: 'bg-yellow-500' },
                    'Released': { text: 'Släppt', color: 'bg-green-500' },
                };

                features.forEach(feature => {
                    const userVoted = !!state.userVotes[feature.recordId];
                    const card = createElement('div', { className: `${theme.cardBg} border ${theme.border} rounded-2xl p-5 flex items-center gap-4` });
                    
                    const voteButton = createElement('button', { 
                        className: `flex flex-col items-center justify-center w-16 h-16 rounded-lg transition-colors flex-shrink-0 ${userVoted ? 'bg-cyan-500 text-white cursor-not-allowed' : `${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`}`,
                        disabled: userVoted,
                        onclick: async (e) => {
                            if (state.userVotes[feature.recordId]) return;

                            const button = e.currentTarget;
                            const votesSpan = button.querySelector('span');
                            const originalVotes = parseInt(feature.votes || 0);
                            
                            button.disabled = true;
                            votesSpan.textContent = originalVotes + 1;
                            button.classList.remove(theme.buttonSecondaryBg, theme.buttonSecondaryHover);
                            button.classList.add('bg-cyan-500', 'text-white', 'cursor-not-allowed');
                            
                            const newVotesState = { ...state.userVotes, [feature.recordId]: true };
                            setState({ userVotes: newVotesState }, { render: false });
                            localStorage.setItem('guldkant-user-votes', JSON.stringify(newVotesState));

                            try {
                                const response = await dataService.voteOnWishlistItem(feature.recordId);
                                const newVoteCount = response.newVotes;

                                votesSpan.textContent = newVoteCount;

                                const updatedItems = state.wishlistItems.map(item =>
                                    item.recordId === feature.recordId ? { ...item, votes: newVoteCount } : item
                                );
                                updatedItems.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                                setState({ wishlistItems: updatedItems });
                            } catch (error) {
                                console.error("Vote failed:", error);
                                const errorMessage = error.message === 'NetworkError' ? 'Nätverksfel.' : error.message;
                                showToast(errorMessage, 'error');
                                
                                votesSpan.textContent = originalVotes;
                                button.classList.add(theme.buttonSecondaryBg, theme.buttonSecondaryHover);
                                button.classList.remove('bg-cyan-500', 'text-white', 'cursor-not-allowed');
                                
                                const revertedVotesState = { ...state.userVotes };
                                delete revertedVotesState[feature.recordId];
                                setState({ userVotes: revertedVotesState }, { render: false });
                                localStorage.setItem('guldkant-user-votes', JSON.stringify(revertedVotesState));
                                button.disabled = false;
                            }
                        }
                    });
                    voteButton.append(
                        createElement('div', { innerHTML: icons.chevronUp('w-6 h-6')}),
                        createElement('span', { className: 'font-bold text-lg' }, feature.votes || 0)
                    );
                    
                    const content = createElement('div', { className: 'flex-grow' });
                    content.append(
                        createElement('h3', { className: 'text-lg font-bold' }, feature.title),
                        createElement('p', { className: `text-sm ${theme.textSecondary} mt-1` }, feature.description || '')
                    );
                    
                    const statusData = statusInfo[feature.status] || statusInfo.idé;
                    const statusTag = createElement('div', { className: `text-xs font-semibold text-white px-2 py-1 rounded-full ${statusData.color}` }, statusData.text);
                    
                    card.append(voteButton, content, statusTag);
                    featureListContainer.append(card);
                });
            }
            
            const suggestionBox = createElement('div', { className: `mt-8 p-6 ${theme.cardBg} border ${theme.border} rounded-2xl` });
            const submitButton = createElement('button', { className: `mt-4 px-6 py-2 font-bold ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} rounded-lg`}, 'Skicka in förslag');
            const suggestionTextarea = createElement('textarea', { placeholder: 'Beskriv din idé här...', className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg} min-h-[100px]` });

            submitButton.onclick = async () => {
                const suggestionText = suggestionTextarea.value.trim();
                if (!suggestionText) {
                    showToast('Vänligen beskriv ditt förslag.', 'error');
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Skickar...';

                try {
                    const newItem = await dataService.addWishlistItem({ title: suggestionText });
                    const newItems = [newItem, ...state.wishlistItems];
                    newItems.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                    
                    setState({ wishlistItems: newItems });
                    suggestionTextarea.value = '';
                    showToast('Tack för ditt förslag!', 'success');
                } catch (error) {
                    console.error("Failed to add suggestion:", error);
                    const errorMessage = error.message === 'NetworkError' ? 'Nätverksfel.' : error.message;
                    showToast(errorMessage, 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Skicka in förslag';
                }
            };

            suggestionBox.append(
                createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Har du ett förslag?'),
                suggestionTextarea,
                submitButton
            );

            return createElement('div', {}, header, featureListContainer, suggestionBox);
        }

        function renderTimePicker() {
            if (!state.isTimePickerOpen) return null;
            const theme = themes[state.theme];
            const overlay = createElement('div', { className: 'fixed inset-0 z-50 ' + theme.modalOverlay, onclick: () => setState({isTimePickerOpen: false}) });
            const picker = createElement('div', { className: `fixed bottom-0 left-0 right-0 h-64 ${theme.cardBg} rounded-t-2xl shadow-2xl flex justify-center items-center animate-slide-in-up`, onclick: e => e.stopPropagation() });
            const container = createElement('div', { className: 'flex items-center justify-center h-full relative w-48' });
            
            const hoursCol = createElement('div', { className: 'h-48 w-24 overflow-y-scroll hide-scrollbar time-picker-column' });
            for(let i=0; i<24; i++) hoursCol.append(createElement('div', {className:'flex items-center justify-center text-xl'}, i.toString().padStart(2,'0')));
            
            const minutesCol = createElement('div', { className: 'h-48 w-24 overflow-y-scroll hide-scrollbar time-picker-column' });
            for(let i=0; i<60; i+=5) minutesCol.append(createElement('div', {className:'flex items-center justify-center text-xl'}, i.toString().padStart(2,'0')));
            
            const selectionIndicator = createElement('div', { className: `absolute top-1/2 -translate-y-1/2 h-10 w-full bg-cyan-500/10 rounded-lg border-2 ${theme.border.replace('slate-200','cyan-500')} pointer-events-none` });
            
            const setButton = createElement('button', { className: `absolute bottom-4 right-4 px-6 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText}`, onclick: () => {
                const hourIndex = Math.round(hoursCol.scrollTop / 40); const minuteIndex = Math.round(minutesCol.scrollTop / 40);
                const time = `${hourIndex.toString().padStart(2,'0')}:${(minuteIndex*5).toString().padStart(2,'0')}`;
                setState({ formData: { ...state.formData, [state.timePickerTarget]: time }, isTimePickerOpen: false });
            }}, 'Ställ in');
            
            container.append(selectionIndicator, hoursCol, minutesCol);
            picker.append(container, setButton);
            overlay.append(picker);
            return overlay;
        }
        
        function renderTemplateEditorModal() {
            if (!state.isTemplateEditorOpen) return null;
            const theme = themes[state.theme];
            let currentTemplates = JSON.parse(JSON.stringify(state.menuTemplates));

            const closeModal = () => setState({ isTemplateEditorOpen: false });

            const modalContent = createElement('div', {
                className: `w-full max-h-full md:max-w-2xl lg:max-w-4xl ${theme.cardBg} flex flex-col shadow-2xl rounded-t-2xl md:rounded-2xl animate-slide-in-up md:animate-fade-in-scale`,
                style: { pointerEvents: 'auto' },
                onclick: e => e.stopPropagation()
            });

            const renderEditorContent = () => {
                const container = createElement('div', { className: 'p-6 space-y-6' });
                Object.entries(currentTemplates).forEach(([category, menus]) => {
                    const categorySection = createElement('div', { className: `p-4 border ${theme.border} rounded-lg` });
                    const categoryHeader = createElement('div', { className: 'flex items-center justify-between mb-4' });
                    const categoryInput = createElement('input', {
                        value: category,
                        className: `text-lg font-semibold ${theme.inputBg} p-2 rounded-md flex-grow`,
                        onchange: (e) => {
                            const newCategory = e.target.value;
                            if (newCategory && !currentTemplates[newCategory]) {
                                currentTemplates[newCategory] = currentTemplates[category];
                                delete currentTemplates[category];
                                rerender();
                            } else {
                                e.target.value = category;
                            }
                        }
                    });
                    const deleteCategoryBtn = createElement('button', { className: 'p-2', innerHTML: icons.trash('w-5 h-5 text-red-500'),
                        onclick: () => {
                            delete currentTemplates[category];
                            rerender();
                        }
                    });
                    categoryHeader.append(categoryInput, deleteCategoryBtn);

                    const menusContainer = createElement('div', { className: 'space-y-4' });
                    Object.entries(menus).forEach(([title, description]) => {
                        const menuRow = createElement('div', { className: 'space-y-2' });
                        const titleInput = createElement('input', {
                            placeholder: 'Menytitel', value: title, className: `w-full p-2 rounded-lg border ${theme.border} ${theme.inputBg}`,
                            onchange: (e) => {
                                const newTitle = e.target.value;
                                if (newTitle && (!currentTemplates[category][newTitle] || newTitle === title)) {
                                    currentTemplates[category][newTitle] = currentTemplates[category][title];
                                    if(newTitle !== title) delete currentTemplates[category][title];
                                    rerender();
                                } else {
                                    e.target.value = title;
                                }
                            }
                        });
                        const descTextarea = createElement('textarea', {
                            placeholder: 'Menybeskrivning', className: `w-full p-2 rounded-lg border ${theme.border} ${theme.inputBg} min-h-[80px]`,
                            onchange: (e) => { currentTemplates[category][title] = e.target.value; }
                        }, description);
                         const deleteMenuBtn = createElement('button', { className: `text-sm font-semibold ${theme.accent}`,
                            onclick: () => {
                                delete currentTemplates[category][title];
                                rerender();
                            }
                        }, 'Ta bort meny');
                        menuRow.append(titleInput, descTextarea, deleteMenuBtn);
                        menusContainer.append(menuRow);
                    });
                    
                    const addMenuBtn = createElement('button', { className: `mt-4 text-sm font-semibold ${theme.accent}`,
                        onclick: () => {
                            const newTitle = `Ny meny ${Object.keys(menus).length + 1}`;
                            currentTemplates[category][newTitle] = "";
                            rerender();
                        }
                    }, '+ Lägg till meny');

                    categorySection.append(categoryHeader, menusContainer, addMenuBtn);
                    container.append(categorySection);
                });

                const addCategoryBtn = createElement('button', { className: `font-semibold ${theme.accent}`,
                    onclick: () => {
                        const newCategory = `Ny Kategori ${Object.keys(currentTemplates).length + 1}`;
                        currentTemplates[newCategory] = {};
                        rerender();
                    }
                }, '+ Lägg till Kategori');
                container.append(addCategoryBtn);

                return container;
            };
            
            const contentWrapper = createElement('div', { className: 'flex-grow overflow-y-auto' });
            const rerender = () => {
                contentWrapper.innerHTML = '';
                contentWrapper.append(renderEditorContent());
            };
            rerender();

            const header = createElement('header', { className: `flex-shrink-0 p-4 border-b ${theme.border} flex items-center justify-between` }, 
                createElement('h2', { className: 'text-xl font-bold' }, 'Hantera Menymallar'), 
                createElement('button', {className:`p-2 ${theme.buttonSecondaryBg} rounded-lg`, innerHTML:icons.x('w-5 h-5'), onclick:closeModal})
            );
            
            const footer = createElement('footer', {className: `flex-shrink-0 p-4 border-t ${theme.border} flex justify-end gap-4`},
                createElement('button', {className:`px-6 py-2 font-bold ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} rounded-lg`, onclick:closeModal}, 'Avbryt'),
                createElement('button', {className:`px-6 py-2 font-bold ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} rounded-lg`, onclick:()=> {
                    localStorage.setItem('guldkant-menu-templates', JSON.stringify(currentTemplates));
                    setState({ menuTemplates: currentTemplates, isTemplateEditorOpen: false });
                    showToast(t('toast.templates_saved'));
                }}, 'Spara & Stäng')
            );
            
            modalContent.append(header, contentWrapper, footer);

            const overlay = createElement('div', { className: 'fixed inset-0 z-40 animate-fade-in-fast ' + theme.modalOverlay, onclick: closeModal });
            const modalPositioner = createElement('div', { className: 'fixed inset-0 z-50 p-0 md:p-8 flex flex-col items-center justify-end md:justify-center', style: { pointerEvents: 'none' }, onclick: closeModal });
            modalPositioner.append(modalContent);
            
            return [overlay, modalPositioner];
        }

        function renderChatLogModal() {
            if (!state.isChatLogModalOpen || !state.formData) return null;

            const theme = themes[state.theme];
            const closeModal = () => setState({ isChatLogModalOpen: false });
            
            const logContent = state.formData.aiRawLog;
            let contentElement;

            if (!logContent || logContent.trim() === "") {
                // Case 1: Loggen är tom
                contentElement = createElement('div', { className: `w-full h-full p-4 ${theme.inputBg} rounded-lg flex items-center justify-center` },
                    createElement('p', { className: theme.textSecondary }, 'Detta ärende skapades manuellt. Ingen chattlogg finns tillgänglig.')
                );
            } else {
                let parsedLog;
                let isJsonFormat = false;
                try {
                    // Försök parsa loggen
                    let tempLog = JSON.parse(logContent);
                    
                    // KONTROLL: Om resultatet är en sträng, är datan "dubbel-paketerad".
                    // Vi måste parsa den en gång till.
                    if (typeof tempLog === 'string') {
                        parsedLog = JSON.parse(tempLog); // Andra parsningen
                    } else {
                        parsedLog = tempLog; // Den var korrekt paketerad
                    }

                    // Kontrollera att det är en array av objekt med rätt struktur
                    if (Array.isArray(parsedLog) && parsedLog.length > 0 && parsedLog.every(e => e.role && e.parts)) {
                        isJsonFormat = true;
                    }
                } catch (e) {
                    isJsonFormat = false;
                    parsedLog = logContent; // Behåll originalsträngen för fallback
                }

                if (isJsonFormat) {
                    // Case 2: Snygg och ren JSON-chattvy
                    contentElement = createElement('div', { className: 'flex flex-col space-y-4 p-2' });
                    
                    parsedLog.forEach(entry => {
                        const role = entry.role;
                        const text = (entry.parts && entry.parts[0] ? entry.parts[0].text : '[Tomt meddelande]')
                            .replace(/\[ÄRENDE_VIDARE\]/g, '') // Ta bort system-taggar
                            .trim();
                        
                        if (!text) return; // Rendera inte tomma meddelanden

                        const isUser = role === 'user';
                        
                        const bubble = createElement('div', {
                            className: `max-w-xs md:max-w-lg p-3 rounded-xl shadow-sm ${isUser ? 'bg-cyan-500 text-white' : `${theme.inputBg} ${theme.text}`}`
                        }, createElement('p', { className: 'text-sm whitespace-pre-wrap' }, text));

                        const label = createElement('span', { className: `text-xs font-semibold mb-1 ${theme.textSecondary}` }, isUser ? 'Kund' : 'Chatt-agent');
                        
                        const messageWrapper = createElement('div', {
                            className: `flex flex-col ${isUser ? 'items-end' : 'items-start'}`
                        }, label, bubble);

                        contentElement.append(messageWrapper);
                    });
                } else {
                    // Case 3: Fallback för vanlig text
                    contentElement = createElement('pre', { 
                        className: `w-full h-full p-4 ${theme.inputBg} rounded-lg overflow-auto whitespace-pre-wrap`,
                        style: { fontFamily: 'monospace' }
                    }, parsedLog); // parsedLog är originalsträngen här
                }
            }

            const modalContent = createElement('div', { 
                className: `w-full max-h-[80vh] md:max-w-xl lg:max-w-2xl ${theme.cardBg} flex flex-col shadow-2xl rounded-t-2xl md:rounded-2xl animate-slide-in-up md:animate-fade-in-scale`,
                style: { pointerEvents: 'auto' },
                onclick: e => e.stopPropagation()
            });

            const header = createElement('header', { className: `flex-shrink-0 p-4 border-b ${theme.border} flex items-center justify-between` }, 
                createElement('h2', { className: 'text-xl font-bold' }, 'Chattlogg för Ärende ' + state.formData.id), 
                createElement('button', {className:`p-2 ${theme.buttonSecondaryBg} rounded-lg`, innerHTML:icons.x('w-5 h-5'), onclick:closeModal})
            );

            const body = createElement('div', { className: 'flex-grow p-4 md:p-6 overflow-hidden' },
                createElement('div', { className: 'h-full max-h-[60vh] overflow-y-auto' }, contentElement)
            );

            modalContent.append(header, body);

            const overlay = createElement('div', { 
                className: 'fixed inset-0 z-50 animate-fade-in-fast ' + theme.modalOverlay, 
                onclick: closeModal 
            });

            const modalPositioner = createElement('div', { 
                className: 'fixed inset-0 z-50 p-0 md:p-8 flex flex-col items-center justify-end md:justify-center',
                style: { pointerEvents: 'none' },
                onclick: closeModal,
            });

            modalPositioner.append(modalContent);
            return [overlay, modalPositioner];
        }

        function renderQuoteModal() {
            if (!state.formData) return null;
            const theme = themes[state.theme];
            const q = state.formData;
            const closeModal = () => setState({ formData: null, selectedQuoteId: null, isModalStatusOpen: false, isQuoteModalFooterMinimized: false });

            const fragment = document.createDocumentFragment();

            const overlay = createElement('div', { 
                className: 'fixed inset-0 z-40 animate-fade-in-fast ' + theme.modalOverlay, 
                onclick: closeModal 
            });
            fragment.append(overlay);

            const modalPositioner = createElement('div', { 
                className: 'fixed inset-0 z-50 p-0 md:p-8 flex flex-col items-center justify-end md:justify-center',
                style: { pointerEvents: 'none' },
                onclick: closeModal,
            });

            const modalContent = createElement('div', { 
                className: `w-full max-h-full md:max-w-2xl lg:max-w-3xl ${theme.cardBg} flex flex-col shadow-2xl rounded-t-2xl md:rounded-2xl animate-slide-in-up md:animate-fade-in-scale`,
                style: { pointerEvents: 'auto' },
                onclick: e => e.stopPropagation()
            });

            const handleStaffInputChange = (key, value) => {
                const newFormData = { ...state.formData, [key]: Number(value) };

                const numChefs = newFormData.numChefs || 0;
                const chefHours = newFormData.chefHours || 0;
                const chefRate = newFormData.chefRate || 0;
                newFormData.chefCost = numChefs * chefHours * chefRate;

                const numServingStaff = newFormData.numServingStaff || 0;
                const servingStaffHours = newFormData.servingStaffHours || 0;
                const servingStaffRate = newFormData.servingStaffRate || 0;
                newFormData.servingStaffCost = numServingStaff * servingStaffHours * servingStaffRate;
                
                newFormData.total = calculateTotal(newFormData);
                state.formData = newFormData;
                
                const details = calculatePriceDetails(newFormData);
                const summaryContainer = document.getElementById('modal-price-summary');
                const totalEl = document.getElementById('modal-total');
                
                if (summaryContainer) {
                    summaryContainer.innerHTML = '';
                    summaryContainer.append(createElement('span', { className: 'text-right' }, `Summa (ex. moms): ${details.subTotal.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`));
                    Object.entries(details.vatBreakdown).sort(([a],[b]) => b - a).forEach(([rate, amount]) => {
                        if (amount > 0.01) {
                            summaryContainer.append(createElement('span', { className: 'text-right' }, `Moms (${rate}%): ${amount.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`));
                        }
                    });
                }

                if(totalEl) totalEl.textContent = `Totalt: ${details.total.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`;
            };

            const update = (key, value) => {
                const newFormData = { ...state.formData, [key]: value };
                newFormData.total = calculateTotal(newFormData);
                state.formData = newFormData;

                const details = calculatePriceDetails(newFormData);
                const summaryContainer = document.getElementById('modal-price-summary');
                const totalEl = document.getElementById('modal-total');
                
                if (summaryContainer) {
                    summaryContainer.innerHTML = '';
                    summaryContainer.append(createElement('span', { className: 'text-right' }, `Summa (ex. moms): ${details.subTotal.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`));
                    Object.entries(details.vatBreakdown).sort(([a],[b]) => b - a).forEach(([rate, amount]) => {
                        if (amount > 0.01) {
                            summaryContainer.append(createElement('span', { className: 'text-right' }, `Moms (${rate}%): ${amount.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`));
                        }
                    });
                }

                if(totalEl) totalEl.textContent = `Totalt: ${details.total.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`;
            };
            
            const statusSelector = createElement('div', { className: 'relative' });
            const statusButtonContent = () => [
                createElement('div', { className: `w-3 h-3 ${statusColors[state.formData.status]} rounded-full` }),
                createElement('span', { className: 'text-sm font-semibold' }, statusTextMap[state.formData.status]),
                createElement('div', { innerHTML: icons.arrowDown('w-4 h-4 text-slate-400') })
            ];
            const statusButton = createElement('button', { className: 'flex items-center gap-2' }, ...statusButtonContent());
            statusButton.onclick = () => {
                 const menu = statusSelector.querySelector('.status-menu');
                 if(menu) { menu.remove(); }
                 else {
                    const newMenu = createElement('div', { className: `status-menu absolute top-full mt-2 w-48 ${theme.cardBg} rounded-lg shadow-lg border ${theme.border} z-10 animate-fade-in-fast` });
                    Object.keys(statusTextMap).forEach(s => newMenu.append(createElement('a', { href: '#', className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700`, onclick: e => { 
                        e.preventDefault(); 
                        update('status', s); 
                        statusButton.innerHTML = '';
                        statusButton.append(...statusButtonContent());
                        newMenu.remove();
                    } }, statusTextMap[s])));
                    statusSelector.append(newMenu);
                 }
            };
            statusSelector.append(statusButton);
            
            const headerContent = createElement('div', {className: 'flex-grow flex items-center gap-4'}, createElement('h2', { className: 'text-xl font-bold' }, q.recordId ? t('modal.edit_title') : t('modal.create_title')), statusSelector);
            const headerButtons = createElement('div', {className:'flex items-center gap-2'},
                createElement('button', {
                    className: `p-2 ${theme.buttonSecondaryBg} rounded-lg`,
                    innerHTML: icons.chatAlt2('w-5 h-5'),
                    onclick: () => setState({ isChatLogModalOpen: true })
                }),
                createElement('button', {
                    className: `p-2 ${theme.buttonSecondaryBg} rounded-lg`,
                    innerHTML: icons.filePdf('w-5 h-5'),
                    onclick: () => generatePdf(q)
                }),
                createElement('button', {
                    className: `p-2 ${theme.buttonSecondaryBg} rounded-lg`,
                    innerHTML: icons.x('w-5 h-5'),
                    onclick: closeModal
                })
            );
            const header = createElement('header', { className: `flex-shrink-0 p-4 border-b ${theme.border}` }, createElement('div', {className: 'flex items-center justify-between'}, headerContent, headerButtons));
            
            const createField = (key, label, type='text', fullWidth=false) => {
                const props = {
                    type, value: q[key] || (type === 'number' ? 0 : ''),
                    className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                    oninput: e => { if (type !== 'number' && type !== 'date') update(key, e.target.value); },
                    onchange: e => { if (type === 'number' || type === 'date') update(key, type === 'number' ? Number(e.target.value) : e.target.value); }
                };
                if(type==='time') {
                    props.type = 'text';
                    props.readOnly = true;
                    props.onclick = () => setState({isTimePickerOpen: true, timePickerTarget: key});
                }
                const input = createElement('input', props);
                return createElement('div', {className: fullWidth ? 'sm:col-span-2' : ''}, createElement('label', {className:'block text-sm font-medium mb-1'}, label), input);
            };
            const createTextarea = (key, label) => createElement('div', {className:'sm:col-span-2'}, createElement('label', {className:'block text-sm font-medium mb-1'}, label), createElement('textarea', {oninput: e=>update(key,e.target.value), className:`w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg} min-h-[100px]`}, q[key]||''));
            
            // --- NY HJÄLPFUNKTION FÖR SELECT ---
            const createSelectField = (key, label, options, fullWidth=false) => {
                const selectEl = createElement('select', {
                    className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                    onchange: e => {
                        // Hantera "Välj..."-alternativet genom att sätta värdet till null
                        const valueToSet = e.target.value === '' ? null : e.target.value;
                        update(key, valueToSet);
                    }
                }, ...options.map(opt => 
                    createElement('option', { 
                        value: opt.value, 
                        // Sätt 'selected' om värdet matchar, hantera null -> ''
                        ...( (q[key] || '') === opt.value ? { selected: true } : {} ) 
                    }, opt.label)
                ));
                
                // Sätt det initiala värdet för <select>-elementet
                selectEl.value = q[key] || '';

                return createElement('div', {className: fullWidth ? 'sm:col-span-2' : ''}, 
                    createElement('label', {className:'block text-sm font-medium mb-1'}, label), 
                    selectEl
                );
            };
            // --- SLUT PÅ NY HJÄLPFUNKTION ---

            const createMenuSection = () => {
                const id = 'menu';
                const theme = themes[state.theme]; // Get theme context
                const q = state.formData; // Get quote data context

                const content = createElement('div', { className: `space-y-4 ${state.openSections[id] ? '' : 'hidden'}` });
                
                // --- START OF NEW CODE ---
                const mainDescWrapper = createElement('div', { className: 'relative space-y-2' });
                const mainDescLabel = createElement('label', { className: 'block text-sm font-medium' }, 'Huvudbeskrivning Meny');
                
                const mainDescTextarea = createElement('textarea', {
                    placeholder: 'Övergripande menybeskrivning (t.ex. "Italiensk buffé")',
                    className: `w-full p-2 rounded-lg border ${theme.border} ${theme.inputBg} min-h-[100px]`,
                    oninput: e => {
                        update('menuDescription', e.target.value);
                    }
                }, q.menuDescription || '');

                const mainTemplateButton = createElement('button', {
                    type: 'button',
                    className: `text-sm font-semibold ${theme.accent}`,
                    onclick: (e) => {
                        e.stopPropagation();
                        const existingMenu = document.getElementById('main-menu-template-popup');
                        if (existingMenu) { existingMenu.remove(); return; }
                        
                        // Ta bort andra öppna menyer
                        document.querySelectorAll('[id^="menu-template-popup-"]').forEach(m => m.remove());

                        const menuPopup = createElement('div', { id: `main-menu-template-popup`, className: `absolute right-0 mt-2 w-full md:w-96 max-h-80 overflow-y-auto ${theme.cardBg} rounded-lg shadow-2xl border ${theme.border} z-20 animate-fade-in-fast` });

                        Object.entries(state.menuTemplates).forEach(([category, menus]) => {
                            menuPopup.append(createElement('h4', { className: `px-4 py-2 font-bold text-xs uppercase ${theme.textSecondary} ${theme.bg}` }, category));
                            Object.entries(menus).forEach(([title, description]) => {
                                menuPopup.append(createElement('a', { href: '#', className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700`, 
                                onclick: (ev) => {
                                    ev.preventDefault();
                                    const currentText = mainDescTextarea.value;
                                    // Append functionality
                                    const newText = (currentText ? currentText.trim() + "\n\n" : "") + description;
                                    
                                    mainDescTextarea.value = newText; // Update view
                                    update('menuDescription', newText); // Update state
                                    menuPopup.remove();
                                } }, title));
                            });
                        });
                        mainDescWrapper.append(menuPopup); // Append to wrapper
                    }
                }, 'Välj från mall (Lägg till)');
                
                mainDescWrapper.append(mainDescLabel, mainDescTextarea, mainTemplateButton);
                content.append(mainDescWrapper);
                
                // Add a separator
                content.append(createElement('hr', { className: theme.border }));
                
                // --- END OF NEW CODE ---

                const menuContainer = createElement('div', { className: 'space-y-4' });

                const rerenderMenuRows = (menuList = state.formData.menuItems) => {
                    menuContainer.innerHTML = '';
                    (menuList || []).forEach((item, index) => {
                        const row = createElement('div', { className: `p-3 border ${theme.border} rounded-lg space-y-2` });
                        
                        const descTextarea = createElement('textarea', {
                            placeholder: 'Menybeskrivning',
                            className: `w-full p-2 rounded-lg border ${theme.border} ${theme.inputBg} min-h-[80px]`,
                            oninput: e => {
                                state.formData.menuItems[index].description = e.target.value;
                                // Ingen full uppdatering, sparas vid "Spara" eller annan prisändring
                            }
                        }, item.description || '');

                        // Add template button for each menu item's textarea
                        const templateButton = createElement('button', {
                            type: 'button',
                            className: `text-sm font-semibold ${theme.accent} mt-1`,
                            onclick: (e) => {
                                e.stopPropagation();
                                const existingMenu = document.getElementById(`menu-template-popup-${index}`);
                                if (existingMenu) { existingMenu.remove(); return; }
                                
                                // Ta bort andra öppna menyer
                                document.querySelectorAll('[id^="menu-template-popup-"]').forEach(m => m.remove());

                                const menuPopup = createElement('div', { id: `menu-template-popup-${index}`, className: `absolute right-0 mt-2 w-full md:w-96 max-h-80 overflow-y-auto ${theme.cardBg} rounded-lg shadow-2xl border ${theme.border} z-20 animate-fade-in-fast` });

                                Object.entries(state.menuTemplates).forEach(([category, menus]) => {
                                    menuPopup.append(createElement('h4', { className: `px-4 py-2 font-bold text-xs uppercase ${theme.textSecondary} ${theme.bg}` }, category));
                                    Object.entries(menus).forEach(([title, description]) => {
                                        menuPopup.append(createElement('a', { href: '#', className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700`, onclick: (ev) => {
                                            ev.preventDefault();
                                            const currentText = descTextarea.value;
                                            // Append functionality
                                            const newText = (currentText ? currentText.trim() + "\n\n" : "") + description;
                                            
                                            descTextarea.value = newText; // Update view
                                            state.formData.menuItems[index].description = newText; // Update state
                                            menuPopup.remove();
                                        } }, title));
                                    });
                                });
                                row.append(menuPopup); // Append to row, relative positioning
                            }
                        }, 'Välj från mall');
                        
                        const descWrapper = createElement('div', { className: 'relative' }, descTextarea, templateButton);

                        const guestInput = createElement('input', {
                            type: 'number', placeholder: 'Antal gäster', value: item.guestCount || '',
                            className: `w-full p-2 rounded-lg border ${theme.border} ${theme.inputBg}`,
                            onchange: e => {
                                state.formData.menuItems[index].guestCount = Number(e.target.value);
                                update('menuItems', state.formData.menuItems);
                                rerenderMenuRows();
                            }
                        });

                        const priceInput = createElement('input', {
                            type: 'number', placeholder: 'Pris/kuvert (inkl. moms)', value: item.pricePerGuest || '',
                            className: `w-full p-2 rounded-lg border ${theme.border} ${theme.inputBg}`,
                            onchange: e => {
                                state.formData.menuItems[index].pricePerGuest = Number(e.target.value);
                                update('menuItems', state.formData.menuItems);
                                rerenderMenuRows();
                            }
                        });

                        const itemTotal = (Number(item.guestCount) || 0) * (Number(item.pricePerGuest) || 0);
                        const totalDisplay = createElement('div', { className: `p-2 text-right ${theme.textSecondary}` }, `Totalt: ${itemTotal.toLocaleString('sv-SE')} kr`);
                        
                        const deleteBtn = createElement('button', {
                            className: 'p-2', innerHTML: icons.trash('w-5 h-5 text-red-500'),
                            onclick: () => {
                                const newItems = state.formData.menuItems.filter((_, i) => i !== index);
                                update('menuItems', newItems);
                                rerenderMenuRows(newItems);
                            }
                        });

                        const controls = createElement('div', { className: 'grid grid-cols-2 gap-2 items-center' }, guestInput, priceInput);
                        const footer = createElement('div', { className: 'flex justify-between items-center' }, deleteBtn, totalDisplay);
                        
                        row.append(descWrapper, controls, footer);
                        menuContainer.append(row);
                    });
                };
                
                rerenderMenuRows(q.menuItems);

                const addButton = createElement('button', {
                    className: `text-sm font-semibold ${theme.accent}`,
                    onclick: () => {
                        const newItems = [...(state.formData.menuItems || []), {
                            description: '',
                            guestCount: state.formData.guestCount || 0, // Default to main guest count
                            pricePerGuest: 0
                        }];
                        update('menuItems', newItems);
                        rerenderMenuRows(newItems);
                    }
                }, '+ Lägg till meny');
                
                // Add 'Kundens önskemål' back, but inside this section
                const customerRequestsTextarea = createTextarea('customerRequests', 'Kundens önskemål');
                
                // Add 'Hantera mallar' button
                const manageTemplatesButton = createElement('button', {
                        type: 'button',
                        className: `flex items-center gap-1 text-sm ${theme.textSecondary} hover:${theme.text} mt-4`,
                        onclick: () => setState({ isTemplateEditorOpen: true })
                    }, createElement('div',{innerHTML: icons.cog('w-4 h-4')}), 'Hantera alla mallar');

                content.append(menuContainer, addButton, customerRequestsTextarea, manageTemplatesButton);

                // --- Wrapper ---
                const icon = createElement('div', { className: 'transition-transform ' + (state.openSections[id] ? 'rotate-180' : ''), innerHTML: icons.arrowDown('w-5 h-5') });
                const header = createElement('div', {
                    className: 'flex items-center justify-between cursor-pointer mb-4',
                    onclick: () => {
                        content.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180');
                        state.openSections[id] = !state.openSections[id];
                    }
                }, createElement('h3', { className: 'text-lg font-semibold' }, 'Meny & Pris'), icon);
                
                return createElement('section', null, header, content);
            };

            const createSection = (title, id, fields) => {
                const content = createElement('div', { className: `grid grid-cols-1 sm:grid-cols-2 gap-4 ${state.openSections[id] ? '' : 'hidden'}` }, ...(fields || []));
                const icon = createElement('div',{className:'transition-transform '+(state.openSections[id] ? 'rotate-180':''), innerHTML:icons.arrowDown('w-5 h-5')});
                const header = createElement('div', { className: 'flex items-center justify-between cursor-pointer mb-4', onclick: () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                    state.openSections[id] = !state.openSections[id];
                }}, createElement('h3',{className:'text-lg font-semibold'}, title), icon);
                return createElement('section', null, header, content);
            };

            const createPersonalCostsSection = () => {
                const id = 'costs';
                const content = createElement('div', { className: `space-y-4 ${state.openSections[id] ? '' : 'hidden'}`});

                const createStaffRow = (type) => {
                    const isChef = type === 'chef';
                    const label = isChef ? 'Kockar' : 'Servering';
                    const numKey = isChef ? 'numChefs' : 'numServingStaff';
                    const hoursKey = isChef ? 'chefHours' : 'servingStaffHours';
                    const rateKey = isChef ? 'chefRate' : 'servingStaffRate';

                    const row = createElement('div', { className: 'grid grid-cols-[1fr_1fr_1fr_1fr] md:grid-cols-[auto_1fr_1fr_1fr] gap-x-2 items-center' },
                        createElement('label', { className: 'font-medium col-span-4 md:col-span-1' }, label),
                        createElement('input', { type: 'number', placeholder: 'Antal', value: q[numKey] || '', onchange: e => handleStaffInputChange(numKey, e.target.value), className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}` }),
                        createElement('input', { type: 'number', placeholder: 'Timmar', value: q[hoursKey] || '', onchange: e => handleStaffInputChange(hoursKey, e.target.value), className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}` }),
                        createElement('input', { type: 'number', placeholder: 'kr/h (ex. moms)', value: q[rateKey] || '', onchange: e => handleStaffInputChange(rateKey, e.target.value), className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}` })
                    );
                    return row;
                };
                
                content.append(
                    createStaffRow('chef'),
                    createStaffRow('serving'),
                    createElement('div', { className: 'pt-2 sm:col-span-2' }, createField('discountAmount', 'Rabatt', 'number', true))
                );

                const icon = createElement('div',{className:'transition-transform '+(state.openSections[id] ? 'rotate-180':''), innerHTML:icons.arrowDown('w-5 h-5')});
                const header = createElement('div', { className: 'flex items-center justify-between cursor-pointer mb-4', onclick: () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                    state.openSections[id] = !state.openSections[id];
                }}, createElement('h3',{className:'text-lg font-semibold'}, 'Personal & Kostnader'), icon);
                return createElement('section', null, header, content);
            };

            const customCostsSection = () => {
                const id = 'customCosts';
                const container = createElement('div', { className: `space-y-4`});

                const renderRows = (costList) => {
                    container.innerHTML = '';
                    (costList || []).forEach((cost, index) => {
                        
                        // --- INPUT ELEMENTEN ---
                        const descInput = createElement('input', {
                            placeholder:'Beskrivning', 
                            value: cost.description || '', 
                            onchange: e => { 
                                state.formData.customCosts[index].description = e.target.value; 
                                // Ingen full uppdatering behövs, sparas vid "Spara"
                            }, 
                            className: `p-2 rounded-lg border ${theme.border} ${theme.inputBg}` 
                        });
                        
                        const qtyInput = createElement('input', {
                            type:'number', 
                            placeholder: 'Antal', 
                            value: cost.quantity || '', 
                            className: `w-20 p-2 rounded-lg border ${theme.border} ${theme.inputBg}` 
                        });

                        const priceInput = createElement('input', {
                            type:'number', 
                            placeholder: 'À-pris (ex. moms)', 
                            value: cost.unitPrice || '', 
                            className: `w-32 p-2 rounded-lg border ${theme.border} ${theme.inputBg}` 
                        });

                        const totalInput = createElement('input', {
                            type:'number', 
                            value: cost.amount || '', 
                            placeholder: 'Totalt (ex. moms)', 
                            className: `w-32 p-2 rounded-lg border ${theme.border} ${theme.inputBg}` 
                        });

                        const vatSelect = createElement('select', { 
                            onchange: e => { 
                                state.formData.customCosts[index].vatRate = Number(e.target.value); 
                                update('customCosts', state.formData.customCosts); 
                            },
                            className: `p-2 rounded-lg border ${theme.border} ${theme.inputBg}`
                        });
                        [0.25, 0.12, 0.06].forEach(rate => {
                            const option = createElement('option', { value: rate }, `${rate * 100}%`);
                            if ((cost.vatRate || 0.25) === rate) {
                                option.selected = true;
                            }
                            vatSelect.append(option);
                        });

                        const deleteBtn = createElement('button', {
                            className: 'p-2', 
                            innerHTML: icons.trash('w-5 h-5 text-red-500'), 
                            onclick: ()=>{
                                const newCosts = state.formData.customCosts.filter((_,i)=>i!==index);
                                update('customCosts', newCosts);
                                renderRows(newCosts);
                            }
                        });

                        // --- LOGIK ---
                        const onUnitChange = () => {
                            const qty = Number(qtyInput.value) || 0;
                            const price = Number(priceInput.value) || 0;
                            const total = qty * price;
                            
                            totalInput.value = total;
                            totalInput.readOnly = true;
                            totalInput.classList.add('bg-slate-200', 'dark:bg-slate-700');

                            state.formData.customCosts[index].quantity = qty;
                            state.formData.customCosts[index].unitPrice = price;
                            state.formData.customCosts[index].amount = total;
                            update('customCosts', state.formData.customCosts);
                        };

                        const onTotalChange = () => {
                            const total = Number(totalInput.value) || 0;
                            
                            qtyInput.value = '';
                            priceInput.value = '';
                            totalInput.readOnly = false;
                            totalInput.classList.remove('bg-slate-200', 'dark:bg-slate-700');

                            state.formData.customCosts[index].quantity = null;
                            state.formData.customCosts[index].unitPrice = null;
                            state.formData.customCosts[index].amount = total;
                            update('customCosts', state.formData.customCosts);
                        };

                        qtyInput.onchange = onUnitChange;
                        priceInput.onchange = onUnitChange;
                        totalInput.onchange = onTotalChange;

                        // --- INITIELLT LÄGE ---
                        if (cost.quantity || cost.unitPrice) {
                            totalInput.readOnly = true;
                            totalInput.classList.add('bg-slate-200', 'dark:bg-slate-700');
                            // Säkerställ att 'amount' är korrekt beräknat
                            const calculatedAmount = (cost.quantity || 0) * (cost.unitPrice || 0);
                            cost.amount = calculatedAmount;
                            totalInput.value = calculatedAmount;
                        } else {
                            totalInput.readOnly = false;
                            totalInput.classList.remove('bg-slate-200', 'dark:bg-slate-700');
                        }

                        // --- MONTERA RADEN ---
                        const row = createElement('div', {className: 'grid grid-cols-[1fr_auto_auto_auto_auto_auto] gap-2 items-center'},
                            descInput,
                            qtyInput,
                            priceInput,
                            totalInput,
                            vatSelect,
                            deleteBtn
                        );
                        container.append(row);
                    });
                };
                
                renderRows(q.customCosts);
                const addButton = createElement('button', {className: `text-sm font-semibold ${theme.accent}`, onclick: () => {
                    const newCosts = [...(state.formData.customCosts || []), {description: '', quantity: null, unitPrice: null, amount: 0, vatRate: 0.25}];
                    update('customCosts', newCosts);
                    renderRows(newCosts);
                }}, '+ Lägg till extra kostnad');
                
                const content = createElement('div', {className: `space-y-4 ${state.openSections[id] ? '' : 'hidden'}`}, container, addButton);
                const icon = createElement('div',{className:'transition-transform '+(state.openSections[id] ? 'rotate-180':''), innerHTML:icons.arrowDown('w-5 h-5')});
                const header = createElement('div', { className: 'flex items-center justify-between cursor-pointer mb-4', onclick: () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                    state.openSections[id] = !state.openSections[id];
                }}, createElement('h3',{className:'text-lg font-semibold'}, 'Extra kostnader'), icon);
                return createElement('section', null, header, content);
            };

            const dietSection = () => {
                const id = 'diets';
                const content = createElement('div', {className: `space-y-4 ${state.openSections[id] ? '':'hidden'}`});
                
                const standardDiets = { vegetarian: 'Vegetarian', vegan: 'Vegan', gluten: 'Glutenfritt', laktos: 'Laktosfritt', notallergi: 'Nötallergi' };
                Object.entries(standardDiets).forEach(([key, label]) => {
                    const count = (q.standardDiets && q.standardDiets[key]) || '';
                    
                    const numberInput = createElement('input', {
                        type:'number', 
                        min:'0', 
                        value: count, 
                        placeholder: '0',
                        onchange: e => {
                            const newCount = Number(e.target.value);
                            const currentDiets = { ...state.formData.standardDiets };
                            if (newCount > 0) {
                                currentDiets[key] = newCount;
                            } else {
                                delete currentDiets[key];
                            }
                            update('standardDiets', currentDiets);
                        }, 
                        className:`w-20 p-2 rounded-lg border ${theme.border} ${theme.inputBg}`
                    });
                    
                    content.append(createElement('div',{className:'flex items-center justify-between gap-4'}, 
                        createElement('label',{className:'flex-grow'},label), 
                        numberInput
                    ));
                });
                
                const customDietsContainer = createElement('div', {className: 'space-y-2'});
                const renderCustomDietRows = (dietList) => {
                    customDietsContainer.innerHTML = '';
                    (dietList || []).forEach((diet, index) => {
                        const row = createElement('div', {className: 'grid grid-cols-[1fr_auto_auto] gap-2 items-center'},
                            createElement('input', {placeholder:'Beskrivning', value: diet.description, oninput: e => { state.formData.customDiets[index].description = e.target.value; update('customDiets', state.formData.customDiets); }, className: `p-2 rounded-lg border ${theme.border} ${theme.inputBg}` }),
                            createElement('input', {type:'number', min:1, value: diet.count, onchange: e => { state.formData.customDiets[index].count = Number(e.target.value); update('customDiets', state.formData.customDiets); }, className: `w-20 p-2 rounded-lg border ${theme.border} ${theme.inputBg}` }),
                            createElement('button', {className: 'p-2', innerHTML: icons.trash('w-5 h-5 text-red-500'), onclick: () => {
                                const newDiets = state.formData.customDiets.filter((_,i)=> i !== index);
                                update('customDiets', newDiets);
                                renderCustomDietRows(newDiets);
                            }})
                        );
                        customDietsContainer.append(row);
                    });
                }
                renderCustomDietRows(q.customDiets);

                content.append(createElement('hr', {className: `my-4 ${theme.border}`}));
                content.append(createElement('h4', {className: 'font-semibold'}, 'Övrig Specialkost'));
                content.append(customDietsContainer);
                content.append(createElement('button', {className: `text-sm font-semibold ${theme.accent}`, onclick: () => {
                    const newDiets = [...(state.formData.customDiets||[]), {id: `d-${Date.now()}`, description:'', count: 1}];
                    update('customDiets', newDiets);
                    renderCustomDietRows(newDiets);
                }}, '+ Lägg till övrig specialkost'));

                const icon = createElement('div',{className:'transition-transform '+(state.openSections[id] ? 'rotate-180':''), innerHTML:icons.arrowDown('w-5 h-5')});
                const header = createElement('div', { className: 'flex items-center justify-between cursor-pointer mb-4', onclick: () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                    state.openSections[id] = !state.openSections[id];
                }}, createElement('h3',{className:'text-lg font-semibold'}, 'Specialkost & Allergener'), icon);
                return createElement('section', null, header, content);
            };

            const formWrapper = createElement('div', { className: 'flex-grow overflow-y-auto p-4 md:p-6 space-y-6' },
                createSection('Kund & Event', 'info', [ 
                    createField('customer', 'Kundnamn'), 
                    createField('contactPerson', 'Kontaktperson'), 
                    createField('customerType', 'Kundtyp'), 
                    createField('customerIdNumber', 'Org/Personnummer'), 
                    createField('contactEmail', 'E-post', 'email'), 
                    createField('contactPhone', 'Telefon', 'tel'), 
                    createField('address', 'Adress', 'text', true), 
                    createField('guestCount', 'Antal personer', 'number'), 
                    createField('eventDate', 'Eventdatum', 'date'), 
                    createField('eventStartTime', 'Starttid', 'time'), 
                    createField('eventEndTime', 'Sluttid', 'time'),
                    // --- PLATS-TAGG SELECT TILLAGD ---
                    createSelectField('locationTag', 'Plats', [
                        { label: 'Välj plats...', value: '' }, 
                        { label: 'Vimmerby', value: 'vimmerby' }, 
                        { label: 'Västervik', value: 'vastervik' }
                    ])
                    // --- SLUT ---
                ]),
                createMenuSection(),
                createPersonalCostsSection(),
                customCostsSection(),
                dietSection(),
                createSection('Interna Noteringar', 'internal', [ createTextarea('internalComment', 'Interna noteringar') ])
            );

            const { subTotal, vat, total, vatBreakdown } = calculatePriceDetails(q);
            const footer = createElement('footer', {className: `flex-shrink-0 border-t ${theme.border} relative`});
            
            const toggleButton = createElement('button', {
                className: `absolute -top-3 left-1/2 -translate-x-1/2 w-10 h-6 ${theme.cardBg} border ${theme.border} rounded-full flex items-center justify-center z-10`,
                onclick: () => {
                    const minimized = !state.isQuoteModalFooterMinimized;
                    setState({ isQuoteModalFooterMinimized: minimized }, { render: false });
                    const content = document.getElementById('modal-footer-content');
                    const icon = document.getElementById('footer-toggle-icon');
                    if (content && icon) {
                        content.classList.toggle('max-h-0', minimized);
                        content.classList.toggle('opacity-0', minimized);
                        content.classList.toggle('invisible', minimized);
                        content.classList.toggle('p-4', !minimized);
                        icon.innerHTML = minimized ? icons.chevronUp('w-5 h-5') : icons.arrowDown('w-5 h-5');
                    }
                }
            }, createElement('div', { id: 'footer-toggle-icon', innerHTML: state.isQuoteModalFooterMinimized ? icons.chevronUp('w-5 h-5') : icons.arrowDown('w-5 h-5')}));

            const footerContent = createElement('div', { id: 'modal-footer-content', className: `transition-all duration-300 overflow-hidden ${state.isQuoteModalFooterMinimized ? 'max-h-0 opacity-0 invisible' : 'max-h-96 opacity-100 visible p-4'}` });

            const summaryContainer = createElement('div', { id: 'modal-price-summary', className:'flex flex-col items-end text-sm gap-1 mb-3'});
            summaryContainer.append(createElement('span', { className: 'text-right' }, `Summa (ex. moms): ${subTotal.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`));
            Object.entries(vatBreakdown).sort(([a],[b]) => b - a).forEach(([rate, amount]) => {
                if (amount > 0.01) {
                    summaryContainer.append(createElement('span', { className: 'text-right' }, `Moms (${rate}%): ${amount.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`));
                }
            });
            
            const footerActions = createElement('div', {className:'flex flex-col md:flex-row md:justify-between md:items-center gap-3'});
            const deleteButton = createElement('button', {
                id: 'modal-delete-btn', // ID TILLAGT
                className: `w-full md:w-auto justify-center px-4 py-2 font-semibold text-red-500 hover:bg-red-100 dark:hover:bg-red-500/10 rounded-lg flex items-center gap-2`,
                onclick: () => {
                    if (!q.recordId) {
                        closeModal();
                        showToast('Utkast raderat.');
                    } else {
                        closeModal();
                        setTimeout(() => setState({ isDeleteConfirmModalOpen: true, quoteToDelete: q }), 100);
                    }
                }
            }, createElement('div', {innerHTML: icons.trash('w-5 h-5')}), 'Radera');

            const mainActions = createElement('div', {className:'flex flex-col md:flex-row items-center gap-3 w-full md:w-auto'},
                createElement('div',{id:'modal-total', className:'text-2xl font-bold order-first md:order-none md:mr-4'}, `Totalt: ${total.toLocaleString('sv-SE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr`),
                createElement('button',{id: 'modal-save-btn', className:`w-full md:w-auto px-6 py-3 font-bold ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} rounded-lg`, onclick:()=>{handleSaveQuote(state.formData); /* closeModal() borttaget */}}, 'Spara'),
                createElement('button',{id: 'modal-send-btn', className:`w-full md:w-auto px-6 py-3 font-bold ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} rounded-lg`, onclick:()=> setState({ isConfirmModalOpen: true, quoteToSend: state.formData })}, 'Skicka Förslag')
            );

            footerActions.append(deleteButton, mainActions);
            footerContent.append(summaryContainer, footerActions);
            footer.append(toggleButton, footerContent);
            
            modalContent.append(header, formWrapper, footer);
            modalPositioner.append(modalContent);
            fragment.append(modalPositioner);
            
            return fragment;
        }

        function renderApp() {
            while (appRoot.firstChild) appRoot.removeChild(appRoot.firstChild);
            if (!state.isLoggedIn) { appRoot.append(renderLogin()); return; }
            const { mainWrapper, mainContent } = renderAppShell();
            if (state.activeView === 'quotes') {
                mainContent.append(renderDashboard());
            } else if (state.activeView === 'analytics') {
                mainContent.append(renderAnalyticsPage());
            } else if (state.activeView === 'wishlist') {
                mainContent.append(renderWishlistPage());
            }
            appRoot.append(mainWrapper);
            if (state.formData) appRoot.append(renderQuoteModal());
            if (state.isTemplateEditorOpen) appRoot.append(...renderTemplateEditorModal());
            if (state.isChatLogModalOpen) appRoot.append(...renderChatLogModal());
            
            if(state.isTimePickerOpen) appRoot.append(renderTimePicker());
            if(state.toast) appRoot.append(renderToast());
            if(state.isConfirmModalOpen) appRoot.append(renderConfirmModal());
            if(state.isDeleteConfirmModalOpen) appRoot.append(renderDeleteConfirmModal());
        }
        
        document.body.addEventListener('click', (e) => {
            const menusToClose = document.querySelectorAll('#global-card-status-menu, #global-filter-status-menu, #menu-template-popup');
            let clickedOnMenuButton = e.target.closest('button'); 

            let shouldClose = true;
            if(clickedOnMenuButton){
                 const clickFn = clickedOnMenuButton.onclick?.toString();
                 if(clickFn && (clickFn.includes('global-card-status-menu') || clickFn.includes('global-filter-status-menu') || clickFn.includes('menu-template-popup'))){
                    shouldClose = false;
                 }
            }
            
            if (shouldClose) {
                menusToClose.forEach(menu => menu.remove());
                 if (state.openCardMenu.id) {
                     setState({openCardMenu: {id: null, target: null}}, {render: false});
                 }
            }
        });


        document.addEventListener('DOMContentLoaded', () => { 
             const savedTheme = localStorage.getItem('guldkant-theme') || 'light';
             state.theme = savedTheme;
             document.documentElement.classList.toggle('dark', savedTheme === 'dark');
             
             const savedTemplates = localStorage.getItem('guldkant-menu-templates');
             try {
                if (savedTemplates) {
                    state.menuTemplates = JSON.parse(savedTemplates);
                } else {
                    state.menuTemplates = defaultMenuTemplates;
                }
             } catch (e) {
                console.error("Kunde inte ladda menymallar:", e);
                state.menuTemplates = defaultMenuTemplates;
             }
             
             const savedVotes = localStorage.getItem('guldkant-user-votes');
             if (savedVotes) {
                 try { state.userVotes = JSON.parse(savedVotes); }
                 catch (e) { console.error('Could not parse user votes', e); state.userVotes = {}; }
             }

             renderApp(); 
        });
        
    </script>
</body>
</html>
