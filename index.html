<!DOCTYPE html>
<html lang="sv" class="light">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guldkant Portalen</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size: 16px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideOutDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fade-in-fast { animation: fadeIn 0.3s ease-out forwards; }
        .animate-fade-out-fast { animation: fadeOut 0.3s ease-out forwards; }
        .animate-fade-in-scale { animation: fadeInScale 0.5s cubic-bezier(0.215, 0.610, 0.355, 1) forwards; }
        .animate-slide-in-up { animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .animate-slide-out-down { animation: slideOutDown 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
        .time-picker-column { scroll-snap-type: y mandatory; scroll-behavior: smooth; padding-top: calc(50% - 20px); padding-bottom: calc(50% - 20px); }
        .time-picker-column > div { scroll-snap-align: center; height: 40px; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">
    <div id="app-root"></div>

    <script type="module">
        const appRoot = document.getElementById('app-root');

        const state = {
            isLoggedIn: false, isLoading: true, quotes: [], selectedQuoteId: null, activeView: 'quotes',
            filter: 'alla', searchTerm: '', toast: null, isHubOpen: false, showWidgets: true,
            theme: 'light',
            formData: null, openSections: { info: true, menu: true, costs: true, customCosts: true, diets: true, internal: true },
            isTimePickerOpen: false, timePickerTarget: null, calendarViewDate: new Date(),
            displayLimit: 12, openCardMenu: { id: null, target: null },
            analyticsSubView: 'overview', isModalStatusOpen: false,
            isConfirmModalOpen: false, quoteToSend: null,
        };

        function setState(newState, options = { render: true }) { Object.assign(state, newState); if (options.render) renderApp(); }

        const texts = { sv: { 'login.welcome': 'Välkommen till Guldkant Portalen', 'login.secret_phrase': 'Hemlig fras', 'login.button': 'Logga in', 'login.error': 'Felaktig fras.', 'nav.catering': 'Catering', 'nav.analytics': 'Analytics', 'nav.calendar': 'Kalender', 'dashboard.subtitle': 'En proaktiv översikt av din cateringverksamhet.', 'controls.new_quote': 'Nytt Ärende', 'status.utkast': 'Utkast', 'status.förslag-skickat': 'Förslag Skickat', 'status.godkänd': 'Godkänd', 'status.genomförd': 'Genomförd', 'status.betald': 'Betald', 'status.förlorad': 'Förlorad Affär', 'status.arkiverad': 'Arkiverad', 'filter.prioriterade': 'Prioriterade', 'filter.aktiva': 'Aktiva', 'filter.kommande': 'Kommande', 'filter.alla': 'Alla Ärenden', 'modal.edit_title': 'Redigera Ärende', 'modal.create_title': 'Skapa Nytt Ärende', 'toast.saved': 'Ärende {id} har sparats.', 'toast.proposal_sent': 'Förslag för {id} har skickats.', 'toast.copied': 'Ärendet kopierades!', 'hub.title': 'NordSym Support Hub', 'hub.copied': 'Kopierad!', 'analytics.overview': 'Översikt', 'analytics.calendar': 'Kalender'} };
        const t = (key, vars = {}) => (texts.sv[key] || key).replace(/{(\w+)}/g, (_, k) => vars[k] || `{${k}}`);

        const N8N_BASE_URL = 'https://nordsym.app.n8n.cloud/webhook/';
        const N8N_ENDPOINTS = { SAVE_QUOTE: 'guldkant-offer-intake-v2', GET_QUOTES: 'quotes', SEND_PROPOSAL: 'quote/dispatch' };
        
        class DataService {
            async _post(endpoint, data) {
                try {
                    const response = await fetch(`${N8N_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`N8N Error: ${response.statusText}`);
                    }
                    const text = await response.text();
                    return text ? JSON.parse(text) : {};
                } catch (e) {
                    if (e instanceof TypeError && e.message === 'Failed to fetch') {
                         throw new Error('NetworkError');
                    }
                    throw e;
                }
            }
            async getQuotes() { const r = await fetch(`${N8N_BASE_URL}${N8N_ENDPOINTS.GET_QUOTES}`); if (!r.ok) throw new Error('Network error'); return (await r.json()).quotes.map(transformN8nQuoteToPortalQuote); }
            async saveQuote(d) { return this._post(N8N_ENDPOINTS.SAVE_QUOTE, transformPortalQuoteToN8nQuote(d)); }
            async sendProposal(d) { return this._post(N8N_ENDPOINTS.SEND_PROPOSAL, transformPortalQuoteToN8nQuote(d)); }
        }
        
        function safeJsonParse(jsonString, defaultValue) {
            if (!jsonString) return defaultValue;
            if (typeof jsonString === 'object') return jsonString;
            if (typeof jsonString !== 'string' || !jsonString.trim()) return defaultValue;
            try {
                const parsed = JSON.parse(jsonString);
                return parsed !== null ? parsed : defaultValue;
            } catch (e) {
                console.warn("JSON Parse Warning:", jsonString, e);
                return defaultValue;
            }
        }

        function normalizeStatus(statusString) {
            if (!statusString || typeof statusString !== 'string') return 'utkast';
            const normalized = statusString.toLowerCase().trim().replace(/\s+/g, '-');
            const statusMap = {
                'förslag-skickat': 'förslag-skickat',
                'godkänd': 'godkänd',
                'accepterad': 'godkänd',
                'genomförd': 'genomförd',
                'betald': 'betald',
                'förlorad': 'förlorad',
                'förlorad-affär': 'förlorad',
                'arkiverad': 'arkiverad',
                'utkast': 'utkast'
            };
            return statusMap[normalized] || 'utkast';
        }

        function transformN8nQuoteToPortalQuote(n8nQuote) {
            const recordId = n8nQuote.recordId || n8nQuote.recordID || null;
            const quoteObject = {
                id: n8nQuote.offertId || n8nQuote.OffertID || n8nQuote.id || `GK-${Date.now()}`,
                recordId: recordId,
                status: normalizeStatus(n8nQuote.status),
                customer: n8nQuote.customerName || n8nQuote.kundNamn || '',
                customerType: n8nQuote.customerType || n8nQuote.kundtyp || 'privat',
                contactPerson: n8nQuote.contactPerson || n8nQuote.kontaktperson || '',
                customerIdNumber: n8nQuote.customerIdNumber || n8nQuote.personnummer || '',
                contactEmail: n8nQuote.contactEmail || n8nQuote.email || '',
                contactPhone: n8nQuote.contactPhone || n8nQuote.telefon || '',
                address: n8nQuote.address || n8nQuote.adress || '',
                guestCount: Number(n8nQuote.guestCount || n8nQuote.antalGaster) || 0,
                eventDate: (n8nQuote.eventDate || n8nQuote.eventDatum) ? new Date(n8nQuote.eventDate || n8nQuote.eventDatum).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                eventStartTime: n8nQuote.eventStartTime || n8nQuote.starttid || "17:00",
                eventEndTime: n8nQuote.eventEndTime || n8nQuote.sluttid || "01:00",
                pricePerGuest: Number(n8nQuote.pricePerGuest || n8nQuote.prisPerKuvert) || 0,
                menuDescription: n8nQuote.menuDescription || n8nQuote.meny || n8nQuote.menuPreference || '',
                customerRequests: n8nQuote.customerRequests || n8nQuote.kundensOnskemal || '',
                numChefs: Number(n8nQuote.numChefs || n8nQuote.antalKockar) || 0,
                chefCost: Number(n8nQuote.chefCost || n8nQuote.kostnadKockar) || 0,
                numServingStaff: Number(n8nQuote.numServingStaff || n8nQuote.antalServering) || 0,
                servingStaffCost: Number(n8nQuote.servingStaffCost || n8nQuote.kostnadServering) || 0,
                discountAmount: Number(n8nQuote.discountAmount || n8nQuote.rabatt) || 0,
                customCosts: safeJsonParse(n8nQuote.customCosts || n8nQuote.extraKostnader, []),
                standardDiets: safeJsonParse(n8nQuote.standardDiets || n8nQuote.standardSpecialkost, {}),
                customDiets: safeJsonParse(n8nQuote.customDiets || n8nQuote.ovrigSpecialkost, []),
                events: safeJsonParse(n8nQuote.events || n8nQuote.handelselogg, [{ timestamp: new Date().toISOString(), event: "Data hämtad från databas" }]),
                internalComment: n8nQuote.internalComment || n8nQuote.internaNoteringar || '',
                total: Number(n8nQuote.total || n8nQuote.totalt) || 0,
                sentDate: n8nQuote.sentDate ? new Date(n8nQuote.sentDate).toLocaleDateString('sv-SE') : null,
                aiRawLog: n8nQuote.aiRawLog || '',
            };
            if (!quoteObject.total) {
                quoteObject.total = calculateTotal(quoteObject);
            }
            return quoteObject;
        }

        function transformPortalQuoteToN8nQuote(portalQuote) {
            const payload = {
                recordId: portalQuote.recordId,
                offertId: portalQuote.id,
                status: portalQuote.status,
                customerName: portalQuote.customer,
                customerType: portalQuote.customerType,
                contactPerson: portalQuote.contactPerson,
                customerIdNumber: portalQuote.customerIdNumber,
                contactEmail: portalQuote.contactEmail,
                contactPhone: portalQuote.contactPhone,
                address: portalQuote.address,
                guestCount: Number(portalQuote.guestCount) || 0,
                eventDate: portalQuote.eventDate,
                eventStartTime: portalQuote.eventStartTime,
                eventEndTime: portalQuote.eventEndTime,
                pricePerGuest: Number(portalQuote.pricePerGuest) || 0,
                menuDescription: portalQuote.menuDescription,
                customerRequests: portalQuote.customerRequests,
                numChefs: Number(portalQuote.numChefs) || 0,
                chefCost: Number(portalQuote.chefCost) || 0,
                numServingStaff: Number(portalQuote.numServingStaff) || 0,
                servingStaffCost: Number(portalQuote.servingStaffCost) || 0,
                discountAmount: Number(portalQuote.discountAmount) || 0,
                total: Number(portalQuote.total) || 0,
                internalComment: portalQuote.internalComment,
                customCosts: portalQuote.customCosts || [],
                standardDiets: portalQuote.standardDiets || {},
                customDiets: portalQuote.customDiets || [],
                events: portalQuote.events || [],
            };
            return payload;
        }

        const dataService = new DataService();
        
        const themes = { 
            light: { bg: 'bg-slate-50', cardBg: 'bg-white', text: 'text-slate-800', textSecondary: 'text-slate-500', accent: 'text-cyan-600', border: 'border-slate-200', inputBg: 'bg-slate-100', buttonPrimaryBg: 'bg-cyan-500', buttonPrimaryText: 'text-white', buttonPrimaryHover: 'hover:bg-cyan-600', buttonSecondaryBg: 'bg-slate-200', buttonSecondaryHover: 'hover:bg-slate-300', modalOverlay: 'bg-slate-900/60 backdrop-blur-sm', navActive: 'bg-cyan-500/10 text-cyan-600 border-cyan-500', navInactive: 'text-slate-600 border-transparent hover:bg-slate-200/50', filterActive: 'bg-cyan-500 text-white', focus: 'focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 ring-offset-slate-50' },
            dark: { bg: 'bg-slate-900', cardBg: 'bg-slate-800', text: 'text-slate-200', textSecondary: 'text-slate-400', accent: 'text-cyan-400', border: 'border-slate-700', inputBg: 'bg-slate-700', buttonPrimaryBg: 'bg-cyan-500', buttonPrimaryText: 'text-white', buttonPrimaryHover: 'hover:bg-cyan-600', buttonSecondaryBg: 'bg-slate-700', buttonSecondaryHover: 'hover:bg-slate-600', modalOverlay: 'bg-slate-900/80 backdrop-blur-sm', navActive: 'bg-cyan-500/10 text-cyan-400 border-cyan-500', navInactive: 'text-slate-400 border-transparent hover:bg-slate-700/50', filterActive: 'bg-cyan-500 text-white', focus: 'focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 ring-offset-slate-900' }
        };

        const formatDate = (date) => new Date(date).toLocaleDateString('sv-SE', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const calculatePriceDetails = (q) => { const base = (Number(q.guestCount) || 0) * (Number(q.pricePerGuest) || 0); const staff = (Number(q.chefCost) || 0) + (Number(q.servingStaffCost) || 0); const custom = (q.customCosts || []).reduce((s, c) => s + (Number(c.amount) || 0), 0); const subTotal = base + staff + custom - (Number(q.discountAmount) || 0); const vat = subTotal * 0.12; return { subTotal, vat, total: subTotal + vat }; };
        const calculateTotal = (q) => calculatePriceDetails(q).total;
        
        function createElement(tag, props = {}, ...children) {
            const el = document.createElement(tag);
            Object.entries(props || {}).forEach(([key, value]) => {
                if (key.startsWith('on') && typeof value === 'function') {
                    el.addEventListener(key.substring(2).toLowerCase(), value);
                } else if (key === 'className') {
                    el.className = value;
                } else if (key === 'innerHTML') {
                    el.innerHTML = value;
                } else if (key === 'style' && typeof value === 'object') {
                    Object.assign(el.style, value);
                } else if(typeof value === 'boolean' && value) {
                    el.setAttribute(key, '');
                } else if (value !== null && value !== undefined) {
                     el.setAttribute(key, value);
                }
            });
            children.forEach(child => {
                if(child) el.append(typeof child === 'string' ? document.createTextNode(child) : child);
            });
            return el;
        }

        const icons = { guldkantLogo: `<img src="https://raw.githubusercontent.com/GusHem/Guldkant-Logga/refs/heads/main/Guldkant%20logga.svg" alt="Guldkant Logotyp" class="w-24 h-24 mx-auto">`, nordsymLogo: `<img src="https://raw.githubusercontent.com/GusHem/Logga-utan-text/refs/heads/main/Final%20logo%20no%20text.svg" alt="NordSym Logotyp" class="w-full h-full">`, arrowDown: c => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`, chevronLeft: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>`, chevronRight: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`, plus: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>`, chartLineUp: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>`, invoice: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`, trash: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`, x: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`, briefcase: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`, calendar: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`, calendarCheck: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2zM7 15l4 4 6-6" /></svg>`, checkCircle: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`, adjustments: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>`, support: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`, tag: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2z M17 17h.01M17 13h5a2 2 0 012 2v5a2 2 0 01-2 2h-5a2 2 0 01-2-2v-5a2 2 0 012-2z"/></svg>`, moon: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`, sun: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`, filePdf: c => `<svg class="${c}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" /></svg>`};
        
        const statusTextMap = Object.keys(texts.sv).filter(k => k.startsWith('status.')).reduce((acc, k) => ({ ...acc, [k.replace('status.', '')]: t(k) }), {});
        const statusColors = { utkast: 'bg-yellow-400', 'förslag-skickat': 'bg-blue-400', godkänd: 'bg-green-500', genomförd: 'bg-indigo-500', betald: 'bg-purple-500', förlorad: 'bg-red-500', arkiverad: 'bg-slate-400' };
        let toastTimer = null;

        function showToast(message, type = 'success') { clearTimeout(toastTimer); setState({ toast: { id: Date.now(), message, type } }); toastTimer = setTimeout(() => setState({ toast: null }), 5000); }
        async function handleSaveQuote(quote, show=true) { 
            const optimisticQuotes = state.quotes.map(q => q.id === quote.id ? quote : q);
            setState({ quotes: optimisticQuotes }, {render: false});
            try { await dataService.saveQuote(quote); if(show) showToast(t('toast.saved', {id: quote.id})); } catch (e) { console.error(e); showToast('Sparning misslyckades.', 'error'); loadInitialData(); } 
            renderApp();
        }
        async function handleSendProposal(quote) {
            setState({ isConfirmModalOpen: false, quoteToSend: null });
            const updatedQuote = { ...quote, status: 'förslag-skickat' };
            const optimisticQuotes = state.quotes.map(q => q.id === updatedQuote.id ? updatedQuote : q);
            setState({ quotes: optimisticQuotes, formData: null, selectedQuoteId: null });
            try { 
                await dataService.sendProposal(updatedQuote); 
                showToast(t('toast.proposal_sent', {id: quote.id})); 
            } catch (e) { 
                console.error(e); 
                if(e.message === 'NetworkError') {
                    showToast('Nätverksfel: Kunde inte skicka förslag.', 'error');
                } else {
                    showToast('Ett okänt fel uppstod.', 'error');
                }
                loadInitialData(); 
            }
        }
        function handleNewQuote() { const newId = `GK-${Date.now()}`; const q = { id: newId, recordId: null, status: 'utkast', guestCount: 20, eventDate: new Date().toISOString().split('T')[0], pricePerGuest: 375, customCosts:[], standardDiets:{}, customDiets:[] }; q.total = calculateTotal(q); setState({ selectedQuoteId: newId, formData: q }); }
        async function loadInitialData() { setState({ isLoading: true }); try { const quotes = await dataService.getQuotes(); setState({ quotes, isLoading: false }); } catch (e) { console.error(e); setState({ isLoading: false, quotes: [] }); showToast('Kunde inte ladda ärenden.', 'error'); } }
        
        function getFilteredAndSortedQuotes() {
            const now = new Date(); now.setHours(0, 0, 0, 0);
            return state.quotes.filter(q => {
                if (!q || !q.status) return false;
                const eventDate = new Date(q.eventDate); const isActive = !['genomförd', 'betald', 'förlorad', 'arkiverad'].includes(q.status);
                const filterLogic = { 'prioriterade': isActive && (eventDate >= now), 'aktiva': isActive, 'kommande': eventDate >= now && !['genomförd', 'betald', 'förlorad'].includes(q.status), 'alla': true };
                const matchesFilter = filterLogic[state.filter] ?? q.status === state.filter;
                if (!matchesFilter) return false;
                const term = state.searchTerm.toLowerCase(); return !term || (q.customer || '').toLowerCase().includes(term) || (q.id || '').toLowerCase().includes(term);
            }).sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate));
        }
        
        function svgToPngDataUrl(svgText, width, height) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                img.onload = () => {
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/png'));
                };

                img.onerror = (e) => {
                    reject(new Error("Misslyckades att ladda SVG-bild för PDF-konvertering."));
                };
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgText)));
            });
        }
        
        async function generatePdf(quote) {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             const logoUrl = 'https://raw.githubusercontent.com/GusHem/Guldkant-Logga/refs/heads/main/Guldkant%20logga.svg';

            // Watermark
            doc.setFontSize(100).setTextColor(230, 230, 230).setFont('helvetica', 'bold');
            doc.text('OFFERT', doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() / 1.5, { angle: -45, align: 'center' });
            doc.setTextColor(0,0,0);


             try {
                const response = await fetch(logoUrl);
                if (!response.ok) throw new Error(`Nätverksfel: ${response.statusText}`);
                const svgText = await response.text();
                const logoPngDataUrl = await svgToPngDataUrl(svgText, 300, 300);
                doc.addImage(logoPngDataUrl, 'PNG', doc.internal.pageSize.getWidth() / 2 - 25, 15, 50, 50);
             } catch(e) {
                console.error("Kunde inte rendera SVG för PDF.", e);
             }
             
             doc.setFontSize(26).setFont('helvetica', 'bold').setTextColor('#b89d50');
             doc.text('GULDKANT', doc.internal.pageSize.getWidth() / 2, 80, { align: 'center' });
             doc.setTextColor(0,0,0);
            
             doc.setFontSize(10).setFont('helvetica', 'bold');
             doc.text('Kund:', 14, 100);
             doc.text('Event:', 120, 100);
             
             doc.setFont('helvetica', 'normal');
             doc.text(quote.customer || '', 14, 106);
             doc.text(quote.contactEmail || '', 14, 111);
             doc.text(quote.contactPhone || '', 14, 116);

             doc.text(formatDate(quote.eventDate), 120, 106);
             doc.text(`${quote.guestCount} personer`, 120, 111);
             doc.text(`${quote.eventStartTime || ''} - ${quote.eventEndTime || ''}`, 120, 116);
             
             doc.text(`Offertnummer: ${quote.id}`, 196, 100, { align: 'right' });


             doc.setFontSize(11).setFont('helvetica', 'bold').text('MENY', 14, 140);
             doc.setFont('helvetica', 'normal').text(doc.splitTextToSize(quote.menuDescription || 'Ej specificerat', 182), 14, 146);
             
             doc.setFontSize(11).setFont('helvetica', 'bold').text('PRISER', 14, 180);

             const { subTotal, vat, total } = calculatePriceDetails(quote); const formatCurrency = (amount) => (amount || 0).toLocaleString('sv-SE') + ' kr';
             const tableRows = [['Mat', `${formatCurrency(quote.pricePerGuest)} x ${quote.guestCount}p`, formatCurrency((quote.guestCount || 0) * (quote.pricePerGuest || 0))]];
             if (quote.chefCost > 0) tableRows.push(['Kockar', 'Fast kostnad', formatCurrency(quote.chefCost)]); if (quote.servingStaffCost > 0) tableRows.push(['Serveringspersonal', 'Fast kostnad', formatCurrency(quote.servingStaffCost)]); (quote.customCosts || []).forEach(c => tableRows.push([c.description, 'Extra kostnad', formatCurrency(c.amount)])); if (quote.discountAmount > 0) tableRows.push(['Rabatt', '', `-${formatCurrency(quote.discountAmount)}`]);
             
             tableRows.push(['', 'Delsumma:', formatCurrency(subTotal)]);
             tableRows.push(['', 'Moms (12%):', formatCurrency(vat)]);
             tableRows.push(['', {content: 'Totalt att betala:', styles:{fontStyle: 'bold'}}, {content: formatCurrency(total), styles:{fontStyle: 'bold'}}]);
             
             doc.autoTable({ 
                startY: 185,
                head: [['Beskrivning', 'Detalj', 'Pris']], body: tableRows, theme: 'plain', 
                headStyles: { fontStyle: 'bold', textColor: [0,0,0] }, 
                columnStyles: { 0: {cellWidth: 100}, 1: {halign: 'right'}, 2: { halign: 'right' } } 
            });

             const pageHeight = doc.internal.pageSize.getHeight();
             doc.setFontSize(8).setFont('helvetica', 'normal');
             const footerText1 = "Offerten är giltig i 30 dagar. När vi är överens om innehåll skickar Guldkant en beställningsbekräftelse via mail som behöver ett godkännande från er sida.";
             const footerText2 = "Menyförslag av. Guldkant, camilla@restaurangguldkant.se / 0739-411422";
             const footerText3 = "Restaurang Guldkant | org nr 556719-3635 | Grönsakstorget 6, 593 33 Västervik";
             doc.text(footerText1, doc.internal.pageSize.getWidth() / 2, pageHeight - 25, { align: 'center' });
             doc.text(footerText2, doc.internal.pageSize.getWidth() / 2, pageHeight - 20, { align: 'center' });
             doc.text(footerText3, doc.internal.pageSize.getWidth() / 2, pageHeight - 15, { align: 'center' });

             doc.save(`Guldkant-Offert-${quote.id}-${quote.eventDate}.pdf`);
        }
        
        function renderLogin() {
            let error = null; 
            const form = createElement('form', { className: 'w-full max-w-sm p-8 space-y-6 bg-white rounded-2xl shadow-2xl animate-fade-in-scale', onsubmit: e => { e.preventDefault(); if (e.target.elements.secretPhrase.value === 'guldbyxor') { setState({isLoggedIn: true}); loadInitialData(); } else { error = t('login.error'); renderApp(); } } });
            form.append(createElement('div', { innerHTML: icons.guldkantLogo }), createElement('h1', { className: 'text-2xl font-bold text-center' }, t('login.welcome')));
            if(error) form.append(createElement('p', {className: 'text-red-500 text-center'}, error));
            form.append(createElement('input', { className: 'w-full p-4 bg-slate-100 rounded-xl', type: 'password', name: 'secretPhrase', placeholder: t('login.secret_phrase') }), createElement('button', { className: 'w-full py-4 font-bold bg-cyan-500 text-white rounded-xl hover:bg-cyan-600' }, t('login.button')));
            return createElement('div', { className: 'min-h-screen w-full bg-slate-50 flex items-center justify-center p-4' }, form);
        }
        function renderToast() { if (!state.toast) return null; const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' }; return createElement('div', { className: `fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 text-white font-medium rounded-full shadow-2xl z-50 animate-fade-in-fast ${colors[state.toast.type]}` }, state.toast.message); }
        function renderSupportHub() { if (!state.isHubOpen) return null; const theme = themes[state.theme]; return createElement('div', { className: `fixed bottom-24 right-8 w-80 ${theme.cardBg} rounded-2xl shadow-2xl p-5 z-40 animate-fade-in-scale border ${theme.border}` }, createElement('h3', {className:'font-bold mb-4'}, t('hub.title')), createElement('div', {className:`flex items-center justify-between p-3 ${theme.inputBg} rounded-lg mb-2`}, createElement('span',{className:'text-sm'},'gustav@nordsym.com'), createElement('button',{className:`text-sm font-semibold ${theme.accent}`, onclick:()=>copy('gustav@nordsym.com','E-post')},'Kopiera')), createElement('div', {className:`flex items-center justify-between p-3 ${theme.inputBg} rounded-lg`}, createElement('span',{className:'text-sm'},'0705292583'), createElement('button',{className:`text-sm font-semibold ${theme.accent}`, onclick:()=>copy('0705292583','Telefon')},'Kopiera'))); }
        function renderConfirmModal() {
            if(!state.isConfirmModalOpen) return null;
            const theme = themes[state.theme];
            return createElement('div', { className: `fixed inset-0 z-50 ${theme.modalOverlay} flex items-center justify-center p-4 animate-fade-in-fast` },
                createElement('div', { className: `${theme.cardBg} rounded-2xl p-6 shadow-2xl max-w-sm w-full text-center animate-fade-in-scale`},
                    createElement('h2', { className: 'text-lg font-bold mb-2' }, 'Skicka förslag till kund?'),
                    createElement('p', { className: `${theme.textSecondary} mb-6`}, 'Ett e-postmeddelande med förslaget kommer att skickas till kunden. Är du säker på att du vill fortsätta?'),
                    createElement('div', { className: 'flex justify-center gap-4' },
                        createElement('button', { className: `px-6 py-2 font-semibold rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, onclick: () => setState({ isConfirmModalOpen: false, quoteToSend: null })}, 'Avbryt'),
                        createElement('button', { className: `px-6 py-2 font-semibold rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover}`, onclick: () => handleSendProposal(state.quoteToSend) }, 'Ja, skicka')
                    )
                )
            );
        }

        function renderAppShell() {
            const theme = themes[state.theme];
            const mainContent = createElement('main', { className: 'ml-16 md:ml-56 p-4 md:p-8' });
            const nav = createElement('nav', { className: `fixed top-0 left-0 h-full w-16 md:w-56 ${theme.cardBg} border-r ${theme.border} flex flex-col z-30 transition-colors` });
            
            const navLinks = [
                { id: 'catering', icon: icons.invoice, text: t('nav.catering'), active: state.activeView === 'quotes', action: () => setState({ activeView: 'quotes' }) },
                { id: 'analytics', icon: icons.chartLineUp, text: t('nav.analytics'), active: state.activeView === 'analytics' && state.analyticsSubView === 'overview', action: () => setState({ activeView: 'analytics', analyticsSubView: 'overview' }) },
                { id: 'calendar', icon: icons.calendar, text: t('nav.calendar'), active: state.activeView === 'analytics' && state.analyticsSubView === 'calendar', action: () => setState({ activeView: 'analytics', analyticsSubView: 'calendar' }) },
            ];

            nav.append(
                createElement('div', { className: `h-20 flex items-center justify-center md:justify-start md:pl-6 border-b ${theme.border} flex-shrink-0`, innerHTML: `<img src="https://raw.githubusercontent.com/GusHem/Guldkant-Logga/refs/heads/main/Guldkant%20logga.svg" alt="Guldkant Logotyp" class="w-10 h-10"><span class="hidden md:inline ml-3 text-xl font-bold ${theme.text}">Guldkant</span>` }),
                createElement('div', { className: 'flex-grow py-4' }, ...navLinks.map(link => 
                    createElement('a', { href: '#', className: `flex items-center h-12 px-5 md:pl-6 my-1 border-l-4 ${link.active ? theme.navActive : theme.navInactive}`, onclick: e => { e.preventDefault(); link.action(); } }, 
                        createElement('div', { className:'w-6 h-6', innerHTML: link.icon('') }), 
                        createElement('span', { className:'hidden md:inline ml-4 font-semibold'}, link.text)
                    )
                )),
                createElement('a', { href: 'https://nordsym.com', target:'_blank', className: `flex-shrink-0 border-t ${theme.border} p-4 flex items-center justify-center md:justify-start group` }, createElement('div', {className:`w-8 h-8 ${theme.textSecondary} group-hover:${theme.accent}`, innerHTML: icons.nordsymLogo}), createElement('span', {className:`hidden md:inline ml-3 text-sm font-semibold ${theme.textSecondary} group-hover:${theme.text}`},'NordSym'))
            );
            const supportFAB = createElement('button', { className: `fixed bottom-8 right-8 w-14 h-14 bg-cyan-500 rounded-full flex items-center justify-center text-white shadow-2xl transform hover:scale-110 transition-transform z-50 ${theme.focus} p-3 ${state.formData ? 'hidden' : ''}`, onclick: () => setState({ isHubOpen: !state.isHubOpen }) }, createElement('div', {className:'w-7 h-7', innerHTML: icons.support('')}));
            return { mainWrapper: createElement('div', {className:`min-h-screen ${theme.bg} transition-colors`}, nav, mainContent, supportFAB), mainContent };
        }
        
        function renderQuoteList() {
            const quotes = getFilteredAndSortedQuotes();
            const contentList = document.getElementById('quote-list-container');
            if (!contentList) return;

            while (contentList.firstChild) {
                contentList.removeChild(contentList.firstChild);
            }

            quotes.slice(0, state.displayLimit).forEach(quote => contentList.append(renderQuoteCard(quote)));
            
            const loadMoreButton = document.getElementById('load-more-btn');
            if (loadMoreButton) {
                if (quotes.length > state.displayLimit) {
                    loadMoreButton.style.display = 'block';
                } else {
                    loadMoreButton.style.display = 'none';
                }
            }
        }

        function renderDashboard() {
            const theme = themes[state.theme];
            
            const themeToggleButton = createElement('button', { 
                className: `p-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, 
                onclick: () => {
                    const newTheme = state.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('guldkant-theme', newTheme);
                    setState({ theme: newTheme });
                    document.documentElement.classList.toggle('dark', newTheme === 'dark');
                }
            }, 
            createElement('div', { innerHTML: state.theme === 'light' ? icons.moon('w-6 h-6') : icons.sun('w-6 h-6')})
            );

            const header = createElement('header', { className: 'flex items-center justify-between' });
            header.append(createElement('div', {}, createElement('p', { className: `mt-1 text-lg ${theme.textSecondary}` }, t('dashboard.subtitle'))), 
            createElement('div', {className: 'flex items-center gap-2'}, themeToggleButton, createElement('button', { className: `p-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, onclick: () => setState({ showWidgets: !state.showWidgets }), innerHTML: icons.adjustments('w-6 h-6') })));
            
            const widgetsContainer = createElement('div', { className: `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 transition-all duration-500 ease-in-out overflow-hidden ${state.showWidgets ? 'max-h-[500px] opacity-100 mt-6' : 'max-h-0 opacity-0 mt-0'}` });
            if(state.showWidgets) {
                const widgetIcons = { 'Aktiva Ärenden': icons.briefcase, 'Nya Förfrågningar': icons.tag, 'Kommande Events (7d)': icons.calendarCheck, 'Fakturerat (30d)': icons.checkCircle };
                const getWidgetData = (filter, label, filterKey) => ({ quotes: state.quotes.filter(filter).slice(0, 3), count: state.quotes.filter(filter).length, label, filterKey});
                const widgetDefs = [ 
                    getWidgetData(q => !['genomförd', 'betald', 'förlorad', 'arkiverad'].includes(q.status), 'Aktiva Ärenden', 'aktiva'), 
                    getWidgetData(q => q.status === 'utkast', 'Nya Förfrågningar', 'utkast'), 
                    getWidgetData(q => { const d = new Date(q.eventDate); const today = new Date(); const in7 = new Date(new Date().setDate(today.getDate() + 7)); return d >= today && d <= in7; }, 'Kommande Events (7d)', 'kommande'),
                    getWidgetData(q => q.status === 'betald' || q.status === 'godkänd', 'Fakturerat (30d)', 'betald')
                ];
                widgetDefs.forEach(def => {
                    const widget = createElement('div', { className: `${theme.cardBg} border ${theme.border} rounded-2xl p-5` }, 
                        createElement('div', {className: 'flex items-start justify-between mb-2 cursor-pointer', onclick: () => setState({filter: def.filterKey})}, 
                            createElement('div', {}, createElement('p', { className: 'text-2xl font-bold' }, def.count.toString()), createElement('p', { className: `text-sm ${theme.textSecondary}` }, def.label)),
                            createElement('div', { className: 'w-8 h-8 p-1.5 bg-cyan-100 text-cyan-600 rounded-lg dark:bg-cyan-500/20 dark:text-cyan-400', innerHTML: widgetIcons[def.label]('w-full h-full')})
                        ),
                         createElement('div', {className:'space-y-1 mt-2'}, ...def.quotes.map(q => 
                            createElement('div', {className: `flex items-center gap-2 p-1 rounded ${theme.bg}`}, 
                                createElement('div', {className:`w-2 h-2 rounded-full ${statusColors[q.status]}`}),
                                createElement('span', {className: 'text-xs truncate'}, q.customer)
                            )
                        ))
                    );
                    widgetsContainer.append(widget);
                });
            }

            const controlsWrapper = createElement('div', { className: `sticky top-0 z-20 py-4 ${theme.bg} transition-colors` });
            const statusDropdownContainer = createElement('div', { className: 'relative flex-shrink-0' });
            
            const statusButton = createElement('button', { className: `flex items-center gap-2 px-4 py-3 font-semibold ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} rounded-lg whitespace-nowrap`, 
                onclick: (e) => {
                    e.stopPropagation();
                    const menu = document.getElementById('global-filter-status-menu');
                    if (menu) {
                        menu.remove();
                    } else {
                         const targetRect = e.currentTarget.getBoundingClientRect();
                         const statuses = ['alla', 'prioriterade', 'aktiva', 'kommande', ...Object.keys(statusTextMap)];
                         const newMenu = createElement('div', { id: 'global-filter-status-menu', className: `fixed w-48 ${theme.cardBg} rounded-lg shadow-lg border ${theme.border} z-30 animate-fade-in-fast`, style: { top: `${targetRect.bottom + 5}px`, left: `${targetRect.left}px`} });
                         [...new Set(statuses)].forEach(status => {
                             newMenu.append(createElement('a', { className: 'block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer', onclick: () => {
                                 setState({ filter: status, displayLimit: 12 });
                                 newMenu.remove();
                            } }, t(`filter.${status}`) || statusTextMap[status]));
                         });
                         document.body.append(newMenu);
                    }
                } 
            }, t(`filter.${state.filter}`) || statusTextMap[state.filter] || 'Status', createElement('div', {innerHTML: icons.arrowDown('w-4 h-4')}));

            statusDropdownContainer.append(statusButton);

            const searchInput = createElement('input', { className: `w-full pl-5 py-3 ${theme.inputBg} rounded-lg`, placeholder: 'Sök på kundnamn eller ID...', value: state.searchTerm, oninput: e => {
                setState({ searchTerm: e.target.value }, { render: false });
                renderQuoteList();
            } });
            const newQuoteButton = createElement('button', { className: `flex items-center gap-2 px-4 py-3 font-semibold ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} rounded-lg ${theme.buttonPrimaryHover} whitespace-nowrap`, onclick: handleNewQuote, innerHTML: icons.plus('w-5 h-5') + `<span class="hidden sm:inline">${t('controls.new_quote')}</span>` });
            
            const controlsFlexContainer = createElement('div', { className: 'flex items-center gap-2 md:gap-4' });
            controlsFlexContainer.append(
                statusDropdownContainer,
                createElement('div', { className: 'flex-grow' }, searchInput),
                newQuoteButton
            );
            controlsWrapper.append(controlsFlexContainer);
            
            const contentList = createElement('div', { id: 'quote-list-container', className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6' });
            const loadMoreButton = createElement('button', { id: 'load-more-btn', className:`md:col-span-full w-full py-3 font-semibold ${theme.buttonSecondaryBg} rounded-lg`, style: {display: 'none'}, onclick:()=>{setState({displayLimit: state.displayLimit+12}, {render:false}); renderQuoteList();} }, 'Ladda fler');
            
            const dashboardContainer = createElement('div', {className: 'space-y-6'}, header, widgetsContainer, controlsWrapper, contentList, loadMoreButton);
            setTimeout(renderQuoteList, 0);
            return dashboardContainer;
        }

        function renderQuoteCard(quote) {
            const theme = themes[state.theme];
            const card = createElement('div', { className: `${theme.cardBg} border ${theme.border} rounded-2xl p-5 flex flex-col gap-4 transition-shadow hover:shadow-xl dark:hover:shadow-cyan-500/10 animate-fade-in-fast relative` });
            const statusButton = createElement('button', {className:'flex items-center gap-2', 
                onclick: (e) => { 
                    e.stopPropagation();
                    const existingMenu = document.getElementById('global-card-status-menu');
                    if (existingMenu) {
                        existingMenu.remove();
                    }
                    if (state.openCardMenu.id !== quote.id) {
                        const targetRect = e.currentTarget.getBoundingClientRect();
                        const menu = createElement('div', { 
                            id: 'global-card-status-menu',
                            className: `fixed w-40 ${theme.cardBg} rounded-lg shadow-lg border ${theme.border} z-50 animate-fade-in-fast`,
                            style: { top: `${targetRect.bottom + 5}px`, left: `${targetRect.left}px`}
                        });
                        Object.keys(statusTextMap).forEach(s => {
                            menu.append(createElement('a', { className: `block px-3 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer`, href: '#', onclick: e => { 
                                e.preventDefault(); 
                                e.stopPropagation(); 
                                handleSaveQuote({...quote, status: s});
                                menu.remove();
                                setState({openCardMenu: {id: null, target: null}}, {render: false});
                            } }, statusTextMap[s]));
                        });
                        document.body.append(menu);
                        setState({openCardMenu: {id: quote.id, target: e.currentTarget}}, {render: false});
                    } else {
                        setState({openCardMenu: {id: null, target: null}}, {render: false});
                    }
                } 
            }, createElement('div', {className:`w-3 h-3 ${statusColors[quote.status]} rounded-full`}), createElement('span',{className:`text-sm font-semibold ${theme.textSecondary}`}, statusTextMap[quote.status]), createElement('div', {innerHTML: icons.arrowDown('w-4 h-4 text-slate-400')}));
            
            const cardContent = createElement('div', { className: 'cursor-pointer', onclick: () => setState({ selectedQuoteId: quote.id, formData: JSON.parse(JSON.stringify(quote)) }) });
            cardContent.append(createElement('h3', {className:'text-lg font-bold truncate mt-2'}, quote.customer || 'Namnlös Offert'));
            cardContent.append(createElement('div', {className:'grid grid-cols-2 gap-4 pt-2 mt-auto'}, createElement('div', {}, createElement('p',{className:`text-xs ${theme.textSecondary}`},'Eventdatum'), createElement('p',{className:'font-semibold'}, formatDate(quote.eventDate))), createElement('div',{className:'text-right'}, createElement('p',{className:`text-xs ${theme.textSecondary}`},'Totalt'), createElement('p',{className:'font-semibold'}, `${Math.round(quote.total).toLocaleString('sv-SE')} kr`))));
            
            card.append(createElement('div', {className:'flex justify-between items-start'}, statusButton), cardContent);

            return card;
        }
        
        function renderAnalyticsPage() {
            const theme = themes[state.theme];
            const header = createElement('div', {}, 
                createElement('h1', { className: 'text-3xl md:text-4xl font-extrabold' }, t('nav.analytics')),
                createElement('p', { className: `mt-1 text-lg ${theme.textSecondary}` }, 'Få insikter om din verksamhet.')
            );

            const tabContainer = createElement('div', { className: `flex items-center gap-4 border-b ${theme.border} mt-6`});
            ['overview', 'calendar'].forEach(view => {
                const isActive = state.analyticsSubView === view;
                tabContainer.append(createElement('button', {
                    className: `py-3 px-4 font-semibold ${isActive ? `border-b-2 ${theme.border.replace('slate-200', 'cyan-500').replace('slate-700', 'cyan-500')} ${theme.accent}` : `${theme.textSecondary} hover:${theme.text}`}`,
                    onclick: () => setState({ analyticsSubView: view })
                }, t(`analytics.${view}`)));
            });

            const contentContainer = createElement('div', { className: 'mt-6' });
            if (state.analyticsSubView === 'calendar') {
                contentContainer.append(renderCalendarView());
            } else {
                contentContainer.append(createElement('div', { className: `flex items-center justify-center h-64 ${theme.cardBg} border ${theme.border} rounded-2xl` }, createElement('p', {className: theme.textSecondary}, 'Översikt under utveckling.')));
            }
            
            return createElement('div', {}, header, tabContainer, contentContainer);
        }

        function renderCalendarView() {
            const theme = themes[state.theme];
            const today = new Date();
            const currentDate = state.calendarViewDate;
            const monthNames = ["Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti", "September", "Oktober", "November", "December"];
            const header = createElement('div', { className: 'flex items-center justify-between mb-4'},
                createElement('h2', { className: 'text-xl font-bold'}, `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`),
                createElement('div', { className: 'flex items-center gap-2'},
                    createElement('button', { className: `p-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, innerHTML: icons.chevronLeft('w-5 h-5'), onclick: () => setState({ calendarViewDate: new Date(currentDate.setMonth(currentDate.getMonth() - 1)) }) }),
                    createElement('button', { className: `p-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`, innerHTML: icons.chevronRight('w-5 h-5'), onclick: () => setState({ calendarViewDate: new Date(currentDate.setMonth(currentDate.getMonth() + 1)) }) })
                )
            );

            const calendarGrid = createElement('div', { className: `grid grid-cols-7 gap-px ${theme.border.replace('border-', 'bg-')} border ${theme.border} rounded-lg overflow-hidden` });
            const days = ['Mån', 'Tis', 'Ons', 'Tor', 'Fre', 'Lör', 'Sön'];
            days.forEach(day => calendarGrid.append(createElement('div', { className: `text-center font-semibold text-sm py-2 ${theme.cardBg} ${theme.textSecondary}` }, day)));

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7; // Måndag = 0

            for (let i = 0; i < startDay; i++) {
                calendarGrid.append(createElement('div', { className: `${theme.bg} min-h-[120px]` }));
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === today.toDateString();
                const dayCell = createElement('div', { className: `${theme.cardBg} p-2 min-h-[120px] flex flex-col` });
                dayCell.append(createElement('div', { className: `w-7 h-7 flex items-center justify-center rounded-full text-sm font-semibold ${isToday ? 'bg-cyan-500 text-white' : ''}` }, day.toString()));
                
                const eventsThisDay = state.quotes.filter(q => new Date(q.eventDate).toDateString() === date.toDateString());
                eventsThisDay.forEach(q => {
                    dayCell.append(createElement('div', { className: `text-xs bg-opacity-20 ${statusColors[q.status]} text-slate-800 dark:text-slate-200 rounded px-1 py-0.5 mt-1 truncate cursor-pointer`, title: q.customer, onclick: () => setState({selectedQuoteId: q.id, formData: JSON.parse(JSON.stringify(q))}) }, q.customer));
                });

                calendarGrid.append(dayCell);
            }

            return createElement('div', { className: `${theme.cardBg} p-4 rounded-2xl border ${theme.border}` }, header, calendarGrid);
        }

        function renderTimePicker() {
            if (!state.isTimePickerOpen) return null;
            const theme = themes[state.theme];
            const overlay = createElement('div', { className: 'fixed inset-0 z-50 ' + theme.modalOverlay, onclick: () => setState({isTimePickerOpen: false}) });
            const picker = createElement('div', { className: `fixed bottom-0 left-0 right-0 h-64 ${theme.cardBg} rounded-t-2xl shadow-2xl flex justify-center items-center animate-slide-in-up`, onclick: e => e.stopPropagation() });
            const container = createElement('div', { className: 'flex items-center justify-center h-full relative w-48' });
            
            const hoursCol = createElement('div', { className: 'h-48 w-24 overflow-y-scroll hide-scrollbar time-picker-column' });
            for(let i=0; i<24; i++) hoursCol.append(createElement('div', {className:'flex items-center justify-center text-xl'}, i.toString().padStart(2,'0')));
            
            const minutesCol = createElement('div', { className: 'h-48 w-24 overflow-y-scroll hide-scrollbar time-picker-column' });
            for(let i=0; i<60; i+=5) minutesCol.append(createElement('div', {className:'flex items-center justify-center text-xl'}, i.toString().padStart(2,'0')));
            
            const selectionIndicator = createElement('div', { className: `absolute top-1/2 -translate-y-1/2 h-10 w-full bg-cyan-500/10 rounded-lg border-2 ${theme.border.replace('slate-200','cyan-500')} pointer-events-none` });
            
            const setButton = createElement('button', { className: `absolute bottom-4 right-4 px-6 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText}`, onclick: () => {
                const hourIndex = Math.round(hoursCol.scrollTop / 40); const minuteIndex = Math.round(minutesCol.scrollTop / 40);
                const time = `${hourIndex.toString().padStart(2,'0')}:${(minuteIndex*5).toString().padStart(2,'0')}`;
                setState({ formData: { ...state.formData, [state.timePickerTarget]: time }, isTimePickerOpen: false });
            }}, 'Ställ in');
            
            container.append(selectionIndicator, hoursCol, minutesCol);
            picker.append(container, setButton);
            overlay.append(picker);
            return overlay;
        }
        
        function renderQuoteModal() {
            if (!state.formData) return null;
            const theme = themes[state.theme];
            const q = state.formData;
            const closeModal = () => setState({ formData: null, selectedQuoteId: null, isModalStatusOpen: false });

            const fragment = document.createDocumentFragment();

            const overlay = createElement('div', { 
                className: 'fixed inset-0 z-40 animate-fade-in-fast ' + theme.modalOverlay, 
                onclick: closeModal 
            });
            fragment.append(overlay);

            const modalPositioner = createElement('div', { 
                className: 'fixed inset-0 z-50 p-0 md:p-8 flex flex-col items-center justify-end md:justify-center',
                style: { pointerEvents: 'none' },
                onclick: closeModal,
            });

            const modalContent = createElement('div', { 
                className: `w-full max-h-full md:max-w-2xl lg:max-w-3xl ${theme.cardBg} flex flex-col shadow-2xl rounded-t-2xl md:rounded-2xl animate-slide-in-up md:animate-fade-in-scale`,
                style: { pointerEvents: 'auto' },
                onclick: e => e.stopPropagation()
            });

            const update = (key, value) => {
                const newFormData = { ...state.formData, [key]: value };
                newFormData.total = calculateTotal(newFormData);
                state.formData = newFormData; // Update state directly for smoothness

                const details = calculatePriceDetails(newFormData);
                const subTotalEl = document.getElementById('modal-subtotal');
                const vatEl = document.getElementById('modal-vat');
                const totalEl = document.getElementById('modal-total');
                if(subTotalEl) subTotalEl.textContent = `Summa: ${details.subTotal.toLocaleString('sv-SE')} kr`;
                if(vatEl) vatEl.textContent = `Moms: ${details.vat.toLocaleString('sv-SE')} kr`;
                if(totalEl) totalEl.textContent = `Totalt: ${details.total.toLocaleString('sv-SE')} kr`;
            };
            
            const statusSelector = createElement('div', { className: 'relative' });
            const statusButtonContent = () => [
                createElement('div', { className: `w-3 h-3 ${statusColors[state.formData.status]} rounded-full` }),
                createElement('span', { className: 'text-sm font-semibold' }, statusTextMap[state.formData.status]),
                createElement('div', { innerHTML: icons.arrowDown('w-4 h-4 text-slate-400') })
            ];
            const statusButton = createElement('button', { className: 'flex items-center gap-2' }, ...statusButtonContent());
            statusButton.onclick = () => {
                 const menu = statusSelector.querySelector('.status-menu');
                 if(menu) { menu.remove(); }
                 else {
                    const newMenu = createElement('div', { className: `status-menu absolute top-full mt-2 w-48 ${theme.cardBg} rounded-lg shadow-lg border ${theme.border} z-10 animate-fade-in-fast` });
                    Object.keys(statusTextMap).forEach(s => newMenu.append(createElement('a', { href: '#', className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700`, onclick: e => { 
                        e.preventDefault(); 
                        update('status', s); 
                        statusButton.innerHTML = '';
                        statusButton.append(...statusButtonContent());
                        newMenu.remove();
                    } }, statusTextMap[s])));
                    statusSelector.append(newMenu);
                 }
            };
            statusSelector.append(statusButton);
            
            const headerContent = createElement('div', {className: 'flex-grow flex items-center gap-4'}, createElement('h2', { className: 'text-xl font-bold' }, q.recordId ? t('modal.edit_title') : t('modal.create_title')), statusSelector);
            const header = createElement('header', { className: `flex-shrink-0 p-4 border-b ${theme.border}` }, createElement('div', {className: 'flex items-center justify-between'}, headerContent, createElement('div', {className:'flex items-center gap-2'}, createElement('button', {className:`p-2 ${theme.buttonSecondaryBg} rounded-lg`, innerHTML:icons.filePdf('w-5 h-5'), onclick:()=>generatePdf(q)}), createElement('button', {className:`p-2 ${theme.buttonSecondaryBg} rounded-lg`, innerHTML:icons.x('w-5 h-5'), onclick:closeModal}))));
            
            const createField = (key, label, type='text', fullWidth=false) => {
                const props = {
                    type, value: q[key] || (type === 'number' ? 0 : ''),
                    className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                    oninput: e => { if (type !== 'number' && type !== 'date') update(key, e.target.value); },
                    onchange: e => { if (type === 'number' || type === 'date') update(key, type === 'number' ? Number(e.target.value) : e.target.value); }
                };
                if(type==='time') props.onclick = () => setState({isTimePickerOpen: true, timePickerTarget: key});
                const input = createElement('input', props);
                return createElement('div', {className: fullWidth ? 'sm:col-span-2' : ''}, createElement('label', {className:'block text-sm font-medium mb-1'}, label), input);
            };
            const createTextarea = (key, label) => createElement('div', {className:'sm:col-span-2'}, createElement('label', {className:'block text-sm font-medium mb-1'}, label), createElement('textarea', {oninput: e=>update(key,e.target.value), className:`w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg} min-h-[100px]`}, q[key]||''));
            
            const createSection = (title, id, fields) => {
                const content = createElement('div', { className: `grid grid-cols-1 sm:grid-cols-2 gap-4 ${state.openSections[id] ? '' : 'hidden'}` }, ...(fields || []));
                const icon = createElement('div',{className:'transition-transform '+(state.openSections[id] ? 'rotate-180':''), innerHTML:icons.arrowDown('w-5 h-5')});
                const header = createElement('div', { className: 'flex items-center justify-between cursor-pointer mb-4', onclick: () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                    state.openSections[id] = !state.openSections[id];
                }}, createElement('h3',{className:'text-lg font-semibold'}, title), icon);
                return createElement('section', null, header, content);
            };

            const customCostsSection = () => {
                const id = 'customCosts';
                const container = createElement('div', { className: `space-y-4`});

                const renderRows = (costList) => {
                    container.innerHTML = '';
                    (costList || []).forEach((cost, index) => {
                        const row = createElement('div', {className: 'grid grid-cols-[1fr_auto_auto] gap-2 items-center'},
                            createElement('input', {placeholder:'Beskrivning', value: cost.description, oninput: e => { state.formData.customCosts[index].description = e.target.value; update('customCosts', state.formData.customCosts); }, className: `p-2 rounded-lg border ${theme.border} ${theme.inputBg}` }),
                            createElement('input', {type:'number', value: cost.amount, onchange: e => { state.formData.customCosts[index].amount = Number(e.target.value); update('customCosts', state.formData.customCosts); }, className: `w-24 p-2 rounded-lg border ${theme.border} ${theme.inputBg}` }),
                            createElement('button', {className: 'p-2', innerHTML: icons.trash('w-5 h-5 text-red-500'), onclick: ()=>{
                                const newCosts = state.formData.customCosts.filter((_,i)=>i!==index);
                                update('customCosts', newCosts);
                                renderRows(newCosts);
                            }})
                        );
                        container.append(row);
                    });
                };
                
                renderRows(q.customCosts);
                const addButton = createElement('button', {className: `text-sm font-semibold ${theme.accent}`, onclick: () => {
                    const newCosts = [...(state.formData.customCosts || []), {description: '', amount: 0}];
                    update('customCosts', newCosts);
                    renderRows(newCosts);
                }}, '+ Lägg till extra kostnad');
                
                const content = createElement('div', {className: `space-y-4 ${state.openSections[id] ? '' : 'hidden'}`}, container, addButton);
                const icon = createElement('div',{className:'transition-transform '+(state.openSections[id] ? 'rotate-180':''), innerHTML:icons.arrowDown('w-5 h-5')});
                const header = createElement('div', { className: 'flex items-center justify-between cursor-pointer mb-4', onclick: () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                    state.openSections[id] = !state.openSections[id];
                }}, createElement('h3',{className:'text-lg font-semibold'}, 'Extra kostnader'), icon);
                return createElement('section', null, header, content);
            };

            const dietSection = () => {
                const id = 'diets';
                const content = createElement('div', {className: `space-y-4 ${state.openSections[id] ? '':'hidden'}`});
                
                const standardDiets = { vegetarian: 'Vegetarian', vegan: 'Vegan', gluten: 'Glutenfritt', laktos: 'Laktosfritt', notallergi: 'Nötallergi' };
                Object.entries(standardDiets).forEach(([key, label]) => {
                    const count = q.standardDiets && q.standardDiets[key];
                    const numberInput = createElement('input', {type:'number', min:'1', value: count || '1', onchange: e=>update('standardDiets',{...(q.standardDiets||{}), [key]:Number(e.target.value) || 1}), className:`w-20 p-2 rounded-lg border ${theme.border} ${theme.inputBg} ${!count ? 'hidden':''}`});
                    const checkbox = createElement('input', {type:'checkbox', checked: !!count, onchange: e => {
                        const currentDiets = state.formData.standardDiets || {};
                        if (e.target.checked) {
                            currentDiets[key] = count || 1;
                        } else {
                            delete currentDiets[key];
                        }
                        update('standardDiets', currentDiets);
                        numberInput.classList.toggle('hidden', !e.target.checked);
                    }, className:'h-5 w-5 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500'});
                    content.append(createElement('div',{className:'flex items-center gap-4'}, checkbox, createElement('label',{className:'flex-grow'},label), numberInput));
                });
                
                const customDietsContainer = createElement('div', {className: 'space-y-2'});
                const renderCustomDietRows = (dietList) => {
                    customDietsContainer.innerHTML = '';
                    (dietList || []).forEach((diet, index) => {
                        const row = createElement('div', {className: 'grid grid-cols-[1fr_auto_auto] gap-2 items-center'},
                            createElement('input', {placeholder:'Beskrivning', value: diet.description, oninput: e => { state.formData.customDiets[index].description = e.target.value; update('customDiets', state.formData.customDiets); }, className: `p-2 rounded-lg border ${theme.border} ${theme.inputBg}` }),
                            createElement('input', {type:'number', min:1, value: diet.count, onchange: e => { state.formData.customDiets[index].count = Number(e.target.value); update('customDiets', state.formData.customDiets); }, className: `w-20 p-2 rounded-lg border ${theme.border} ${theme.inputBg}` }),
                            createElement('button', {className: 'p-2', innerHTML: icons.trash('w-5 h-5 text-red-500'), onclick: () => {
                                const newDiets = state.formData.customDiets.filter((_,i)=> i !== index);
                                update('customDiets', newDiets);
                                renderCustomDietRows(newDiets);
                            }})
                        );
                        customDietsContainer.append(row);
                    });
                }
                renderCustomDietRows(q.customDiets);

                content.append(createElement('hr', {className: `my-4 ${theme.border}`}));
                content.append(createElement('h4', {className: 'font-semibold'}, 'Övrig Specialkost'));
                content.append(customDietsContainer);
                content.append(createElement('button', {className: `text-sm font-semibold ${theme.accent}`, onclick: () => {
                    const newDiets = [...(state.formData.customDiets||[]), {id: `d-${Date.now()}`, description:'', count: 1}];
                    update('customDiets', newDiets);
                    renderCustomDietRows(newDiets);
                }}, '+ Lägg till övrig specialkost'));

                const icon = createElement('div',{className:'transition-transform '+(state.openSections[id] ? 'rotate-180':''), innerHTML:icons.arrowDown('w-5 h-5')});
                const header = createElement('div', { className: 'flex items-center justify-between cursor-pointer mb-4', onclick: () => {
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                    state.openSections[id] = !state.openSections[id];
                }}, createElement('h3',{className:'text-lg font-semibold'}, 'Specialkost & Allergener'), icon);
                return createElement('section', null, header, content);
            };

            const formWrapper = createElement('div', { className: 'flex-grow overflow-y-auto p-4 md:p-6 space-y-6' },
                createSection('Kund & Event', 'info', [ createField('customer', 'Kundnamn'), createField('contactPerson', 'Kontaktperson'), createField('customerType', 'Kundtyp'), createField('customerIdNumber', 'Org/Personnummer'), createField('contactEmail', 'E-post', 'email'), createField('contactPhone', 'Telefon', 'tel'), createField('address', 'Adress', 'text', true), createField('guestCount', 'Antal gäster', 'number'), createField('eventDate', 'Eventdatum', 'date'), createField('eventStartTime', 'Starttid', 'time'), createField('eventEndTime', 'Sluttid', 'time') ]),
                createSection('Meny & Pris', 'menu', [ createField('pricePerGuest', 'Pris per kuvert (exkl. moms)', 'number'), createTextarea('menuDescription', 'Menybeskrivning'), createTextarea('customerRequests', 'Kundens önskemål') ]),
                createSection('Personal & Kostnader', 'costs', [ createField('numChefs', 'Antal Kockar', 'number'), createField('chefCost', 'Kostnad kockar', 'number'), createField('numServingStaff', 'Antal Servering', 'number'), createField('servingStaffCost', 'Kostnad servering', 'number'), createField('discountAmount', 'Rabatt', 'number', true) ]),
                customCostsSection(),
                dietSection(),
                createSection('Interna Noteringar', 'internal', [ createTextarea('internalComment', 'Interna noteringar') ])
            );

            const { subTotal, vat, total } = calculatePriceDetails(q);
            const footer = createElement('footer', {className: `flex-shrink-0 p-4 border-t ${theme.border}`});
            footer.append(createElement('div', {className:'flex justify-end text-sm gap-4 mb-3'}, createElement('span', {id:'modal-subtotal'}, `Summa: ${subTotal.toLocaleString('sv-SE')} kr`), createElement('span', {id:'modal-vat'}, `Moms: ${vat.toLocaleString('sv-SE')} kr`)));
            footer.append(createElement('div', {className:'flex justify-between items-center'}, createElement('div',{id:'modal-total', className:'text-2xl font-bold'}, `Totalt: ${total.toLocaleString('sv-SE')} kr`), createElement('div', {className:'flex items-center gap-3'}, createElement('button',{className:`px-6 py-3 font-bold ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} rounded-lg`, onclick:()=>{handleSaveQuote(state.formData); closeModal()}}, 'Spara'), createElement('button',{className:`px-6 py-3 font-bold ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} rounded-lg`, onclick:()=> setState({ isConfirmModalOpen: true, quoteToSend: state.formData })}, 'Skicka Förslag'))));
            
            modalContent.append(header, formWrapper, footer);
            modalPositioner.append(modalContent);
            fragment.append(modalPositioner);
            
            return fragment;
        }

        function renderApp() {
            while (appRoot.firstChild) appRoot.removeChild(appRoot.firstChild);
            if (!state.isLoggedIn) { appRoot.append(renderLogin()); return; }
            const { mainWrapper, mainContent } = renderAppShell();
            if (state.activeView === 'quotes') {
                mainContent.append(renderDashboard());
            } else if (state.activeView === 'analytics') {
                mainContent.append(renderAnalyticsPage());
            }
            appRoot.append(mainWrapper);
            if(state.formData) appRoot.append(renderQuoteModal());
            if(state.isHubOpen) appRoot.append(renderSupportHub());
            if(state.isTimePickerOpen) appRoot.append(renderTimePicker());
            if(state.toast) appRoot.append(renderToast());
            if(state.isConfirmModalOpen) appRoot.append(renderConfirmModal());
        }
        
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                 const globalMenu = document.getElementById('global-card-status-menu') || document.getElementById('global-filter-status-menu');
                 if(globalMenu) globalMenu.remove();
                 if (state.openCardMenu.id) {
                     setState({openCardMenu: {id: null, target: null}}, {render: false});
                 }
            }
        });

        document.addEventListener('DOMContentLoaded', () => { 
             const savedTheme = localStorage.getItem('guldkant-theme') || 'light';
             state.theme = savedTheme;
             document.documentElement.classList.toggle('dark', savedTheme === 'dark');
             renderApp(); 
        });
        
    </script>
</body>
</html>

